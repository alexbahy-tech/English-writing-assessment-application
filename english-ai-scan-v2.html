<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>English AI Scan - Asisten Penilaian Menulis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- Google Analytics - Ganti GA_MEASUREMENT_ID dengan ID Anda -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'GA_MEASUREMENT_ID');
    
    // Track custom events
    function trackEvent(eventName, eventParams) {
      if (typeof gtag !== 'undefined') {
        gtag('event', eventName, eventParams);
      }
    }
  </script>
  
  <style>
    * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
    body { margin: 0; padding: 0; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
    .animate-slideIn { animation: slideIn 0.3s ease-out; }
    .animate-spin { animation: spin 1s linear infinite; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    input, textarea, select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      ring: 2px;
      ring-color: #3b82f6;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/70 backdrop-blur-md z-50 hidden items-center justify-center">
    <div class="bg-white p-10 rounded-3xl text-center space-y-6 max-w-sm mx-4 shadow-2xl">
      <div class="relative w-20 h-20 mx-auto">
        <div class="absolute inset-0 border-4 border-blue-200 rounded-full"></div>
        <div class="absolute inset-0 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
      </div>
      <div>
        <p class="font-black text-xl text-slate-800">Menganalisis...</p>
        <p class="text-slate-500 text-sm mt-1">AI sedang membaca dan menilai tulisan</p>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="fixed top-4 right-4 z-50 px-6 py-3 rounded-xl shadow-xl hidden text-white font-medium"></div>

  <!-- Main Container -->
  <div class="pb-24 md:pb-0 md:pl-24">
    
    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 w-full md:w-24 md:h-full bg-slate-900 text-white flex md:flex-col items-center justify-around md:justify-start py-3 md:py-8 z-40 shadow-2xl">
      <div class="hidden md:flex w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl items-center justify-center font-black text-lg mb-8 shadow-lg">
        AI
      </div>
      <div class="flex md:flex-col gap-2 md:gap-4 w-full md:w-auto px-4 md:px-0 justify-around md:justify-start">
        <button onclick="showTab('dashboard')" id="nav-dashboard" class="nav-btn p-3 md:p-4 rounded-xl md:rounded-2xl transition-all flex flex-col md:flex-row items-center gap-1 text-slate-400 hover:text-white hover:bg-slate-800">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
          <span class="text-[10px] md:hidden">Home</span>
        </button>
        <button onclick="showTab('new')" id="nav-new" class="nav-btn p-3 md:p-4 rounded-xl md:rounded-2xl transition-all flex flex-col md:flex-row items-center gap-1 text-slate-400 hover:text-white hover:bg-slate-800">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          <span class="text-[10px] md:hidden">Baru</span>
        </button>
        <button onclick="showTab('history')" id="nav-history" class="nav-btn p-3 md:p-4 rounded-xl md:rounded-2xl transition-all flex flex-col md:flex-row items-center gap-1 text-slate-400 hover:text-white hover:bg-slate-800">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <span class="text-[10px] md:hidden">Riwayat</span>
        </button>
        <button onclick="showTab('guide')" id="nav-guide" class="nav-btn p-3 md:p-4 rounded-xl md:rounded-2xl transition-all flex flex-col md:flex-row items-center gap-1 text-slate-400 hover:text-white hover:bg-slate-800">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
          <span class="text-[10px] md:hidden">Panduan</span>
        </button>
        <button onclick="showTab('stats')" id="nav-stats" class="nav-btn p-3 md:p-4 rounded-xl md:rounded-2xl transition-all flex flex-col md:flex-row items-center gap-1 text-slate-400 hover:text-white hover:bg-slate-800">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
          <span class="text-[10px] md:hidden">Statistik</span>
        </button>
        <button onclick="showTab('settings')" id="nav-settings" class="nav-btn p-3 md:p-4 rounded-xl md:rounded-2xl transition-all flex flex-col md:flex-row items-center gap-1 text-slate-400 hover:text-white hover:bg-slate-800">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
          <span class="text-[10px] md:hidden">Profil</span>
        </button>
      </div>
    </nav>

    <!-- Header -->
    <header class="h-16 md:h-20 bg-white/80 backdrop-blur-lg border-b border-slate-100 px-4 md:px-8 flex items-center justify-between sticky top-0 z-30">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 md:hidden bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white font-black text-sm">AI</div>
        <h1 class="text-lg md:text-xl font-black text-slate-800">English AI Scan</h1>
      </div>
      <div id="headerProfile" class="text-right hidden">
        <p id="headerName" class="text-sm font-bold text-slate-800"></p>
        <p id="headerSchool" class="text-xs text-slate-400"></p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 md:p-8">
      
      <!-- Setup Page -->
      <div id="tab-setup" class="tab-content active">
        <div class="min-h-[80vh] flex items-center justify-center">
          <div class="bg-white p-8 md:p-12 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100 animate-fadeIn">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white mb-8 mx-auto shadow-lg">
              <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
            </div>
            <h1 class="text-3xl font-black text-center mb-2 text-slate-800">English AI Scan</h1>
            <p class="text-center text-slate-500 mb-8">Asisten Penilaian Menulis Bahasa Inggris</p>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-slate-600 mb-2">Nama Lengkap & Gelar</label>
                <input 
                  type="text"
                  id="setupName" 
                  placeholder="Contoh: Budi Santoso, S.Pd" 
                  class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                >
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-600 mb-2">Nama Sekolah</label>
                <input 
                  type="text"
                  id="setupSchool" 
                  placeholder="Contoh: SMA Negeri 1 Jakarta" 
                  class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                >
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-600 mb-2">Google Gemini API Key</label>
                <input 
                  type="password"
                  id="setupApiKey" 
                  placeholder="Masukkan API Key..." 
                  class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                >
                <p class="text-xs text-slate-400 mt-2">
                  Dapatkan API Key gratis di 
                  <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a>
                </p>
              </div>
              <button 
                onclick="saveProfile()"
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-xl font-bold shadow-xl hover:shadow-blue-300/50 active:scale-[0.98] transition-all mt-4"
              >
                Mulai Menggunakan Aplikasi
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Page -->
      <div id="tab-dashboard" class="tab-content">
        <div class="max-w-6xl mx-auto space-y-8 animate-fadeIn">
          <!-- Welcome Banner -->
          <div class="relative overflow-hidden bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-800 rounded-3xl p-8 md:p-12 text-white">
            <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-32 translate-x-32"></div>
            <div class="relative z-10">
              <p class="text-blue-100 text-sm">Selamat Datang,</p>
              <h1 id="welcomeName" class="text-2xl md:text-3xl font-black mb-2"></h1>
              <p id="welcomeSchool" class="text-blue-100 mb-6"></p>
              <button 
                onclick="startNewAssessment()"
                class="inline-flex items-center gap-2 bg-white text-blue-700 px-6 py-3 rounded-xl font-bold hover:bg-blue-50 transition-all"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Mulai Penilaian Baru
              </button>
            </div>
          </div>

          <!-- Stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
              <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center mb-4">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
              </div>
              <p id="statTotal" class="text-3xl font-black text-slate-800">0</p>
              <p class="text-sm text-slate-500">Total Siswa</p>
            </div>
            <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
              <div class="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center mb-4">
                <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
              </div>
              <p id="statAvg" class="text-3xl font-black text-slate-800">0</p>
              <p class="text-sm text-slate-500">Rata-rata Skor</p>
            </div>
            <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
              <div class="w-12 h-12 bg-purple-50 rounded-xl flex items-center justify-center mb-4">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
              </div>
              <p id="statTop" class="text-3xl font-black text-slate-800">-</p>
              <p class="text-sm text-slate-500">Level Terbanyak</p>
            </div>
            <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
              <div class="w-12 h-12 bg-amber-50 rounded-xl flex items-center justify-center mb-4">
                <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              </div>
              <p id="statWeek" class="text-3xl font-black text-slate-800">0</p>
              <p class="text-sm text-slate-500">Minggu Ini</p>
            </div>
          </div>

          <!-- Recent -->
          <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
            <div class="p-6 border-b border-slate-100">
              <h2 class="text-xl font-black text-slate-800">Penilaian Terbaru</h2>
            </div>
            <div id="recentList" class="divide-y divide-slate-50">
              <div class="p-12 text-center">
                <svg class="w-12 h-12 mx-auto text-slate-200 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                <p class="text-slate-400">Belum ada penilaian</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- New Assessment Page -->
      <div id="tab-new" class="tab-content">
        <div class="max-w-4xl mx-auto animate-fadeIn">
          
          <!-- Progress Steps -->
          <div class="mb-8">
            <div class="flex items-center justify-between max-w-md mx-auto">
              <div class="flex flex-col items-center">
                <div id="step1" class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-blue-600 text-white shadow-lg">1</div>
                <span class="text-xs mt-2 font-medium text-blue-600">Data</span>
              </div>
              <div id="line1" class="flex-1 h-1 mx-2 rounded-full bg-slate-100"></div>
              <div class="flex flex-col items-center">
                <div id="step2" class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-slate-100 text-slate-400">2</div>
                <span class="text-xs mt-2 font-medium text-slate-400">Input</span>
              </div>
              <div id="line2" class="flex-1 h-1 mx-2 rounded-full bg-slate-100"></div>
              <div class="flex flex-col items-center">
                <div id="step3" class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-slate-100 text-slate-400">3</div>
                <span class="text-xs mt-2 font-medium text-slate-400">Analisis</span>
              </div>
              <div id="line3" class="flex-1 h-1 mx-2 rounded-full bg-slate-100"></div>
              <div class="flex flex-col items-center">
                <div id="step4" class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-slate-100 text-slate-400">4</div>
                <span class="text-xs mt-2 font-medium text-slate-400">Hasil</span>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-3xl p-6 md:p-10 shadow-xl border border-slate-100">
            
            <!-- Step 1: Student Data -->
            <div id="stepContent1" class="space-y-6">
              <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                </div>
                <h2 class="text-2xl font-black text-slate-800">Data Siswa & Pembelajaran</h2>
                <p class="text-slate-500">Masukkan informasi siswa dan tujuan pembelajaran</p>
              </div>
              
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-slate-600 mb-2">Nama Siswa *</label>
                  <input 
                    type="text"
                    id="studentName" 
                    placeholder="Contoh: Ahmad Rizki" 
                    class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all"
                  >
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-600 mb-2">Kelas *</label>
                  <input 
                    type="text"
                    id="studentClass" 
                    placeholder="Contoh: X IPA 2" 
                    class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all"
                  >
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-600 mb-2">WhatsApp (opsional)</label>
                  <input 
                    type="tel"
                    id="studentWhatsapp" 
                    placeholder="62812xxxxxxxx"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                    onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                    maxlength="15"
                    class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all"
                  >
                  <p class="text-xs text-slate-400 mt-1">Contoh: 6281234567890 (tanpa + atau spasi)</p>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-slate-600 mb-2">Genre Tulisan *</label>
                  <select 
                    id="studentGenre"
                    class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all cursor-pointer"
                  >
                    <option value="Narrative">Narrative</option>
                    <option value="Descriptive">Descriptive</option>
                    <option value="Procedure">Procedure</option>
                    <option value="Recount">Recount</option>
                    <option value="Report">Report</option>
                    <option value="Exposition">Exposition</option>
                    <option value="Discussion">Discussion</option>
                    <option value="Explanation">Explanation</option>
                    <option value="Review">Review</option>
                    <option value="News Item">News Item</option>
                  </select>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-slate-600 mb-2">Topik / Judul (opsional)</label>
                <input 
                  type="text"
                  id="studentTopic" 
                  placeholder="Contoh: My Holiday Experience" 
                  class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all"
                >
              </div>

              <!-- Capaian & Tujuan Pembelajaran Section -->
              <div class="border-t border-slate-200 pt-6 mt-6">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                      <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                    </div>
                    <div>
                      <h3 class="font-bold text-slate-800">Capaian & Tujuan Pembelajaran</h3>
                      <p class="text-xs text-slate-500">Untuk penilaian yang lebih kontekstual</p>
                    </div>
                  </div>
                </div>

                <!-- Option to use previous CP/TP -->
                <div id="previousCPTPOption" class="hidden mb-4">
                  <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4">
                    <label class="flex items-start gap-3 cursor-pointer">
                      <input 
                        type="checkbox" 
                        id="usePreviousCPTP" 
                        onchange="toggleCPTPFields()"
                        class="mt-1 w-5 h-5 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500"
                      >
                      <div>
                        <span class="font-semibold text-indigo-800">Gunakan CP & TP sebelumnya</span>
                        <p id="previousCPTPPreview" class="text-xs text-indigo-600 mt-1"></p>
                      </div>
                    </label>
                  </div>
                </div>

                <!-- CP/TP Input Fields -->
                <div id="cptpFields" class="space-y-4">
                  <div>
                    <label class="block text-sm font-semibold text-slate-600 mb-2">
                      Capaian Pembelajaran (CP)
                      <span class="font-normal text-slate-400">- opsional</span>
                    </label>
                    <textarea 
                      id="capaianPembelajaran"
                      placeholder="Contoh: Peserta didik mampu menulis teks naratif sederhana dengan memperhatikan fungsi sosial, struktur teks, dan unsur kebahasaan..."
                      class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all resize-none h-24"
                    ></textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-slate-600 mb-2">
                      Tujuan Pembelajaran (TP)
                      <span class="font-normal text-slate-400">- opsional</span>
                    </label>
                    <textarea 
                      id="tujuanPembelajaran"
                      placeholder="Contoh: 1. Siswa dapat menulis teks naratif dengan struktur yang tepat (orientation, complication, resolution)&#10;2. Siswa dapat menggunakan simple past tense dengan benar&#10;3. Siswa dapat mengembangkan ide cerita secara kreatif"
                      class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all resize-none h-32"
                    ></textarea>
                  </div>
                </div>

                <div class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                  <p class="text-xs text-amber-700">
                    <strong>üí° Tips:</strong> CP & TP akan disimpan dan bisa digunakan kembali untuk penilaian berikutnya. Anda bisa mengubahnya kapan saja jika asesmen berbeda.
                  </p>
                </div>
              </div>

              <button 
                onclick="goToStep2()"
                class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-700 transition-colors shadow-lg"
              >
                Lanjutkan
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
              </button>
            </div>

            <!-- Step 2: Input Method -->
            <div id="stepContent2" class="space-y-6 hidden">
              <div class="text-center mb-6">
                <h2 class="text-2xl font-black text-slate-800">Metode Input</h2>
                <p class="text-slate-500">Pilih cara memasukkan tulisan siswa</p>
              </div>

              <!-- Mode Toggle -->
              <div class="flex gap-2 p-1.5 bg-slate-100 rounded-xl max-w-md mx-auto">
                <button id="modeCamera" onclick="setInputMode('camera')" class="flex-1 py-3 px-4 rounded-lg font-semibold flex items-center justify-center gap-2 bg-white shadow-md text-blue-600">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  Scan/Upload
                </button>
                <button id="modeText" onclick="setInputMode('text')" class="flex-1 py-3 px-4 rounded-lg font-semibold flex items-center justify-center gap-2 text-slate-500">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                  Ketik Manual
                </button>
              </div>

              <!-- Camera/Upload Mode -->
              <div id="cameraModeContent" class="text-center space-y-6">
                <div id="cameraPreview" class="hidden">
                  <video id="videoPreview" autoplay playsinline class="w-full max-w-md mx-auto rounded-2xl shadow-lg aspect-[3/4] object-cover bg-black"></video>
                  <div class="flex justify-center gap-4 mt-4">
                    <button onclick="stopCamera()" class="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold">Batal</button>
                    <button onclick="capturePhoto()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold">Ambil Foto</button>
                  </div>
                </div>
                
                <div id="imagePreview" class="hidden">
                  <img id="capturedImage" class="w-full max-w-md mx-auto rounded-2xl shadow-lg" alt="Captured">
                  <div class="flex justify-center gap-4 mt-4">
                    <button onclick="clearImage()" class="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold">Ambil Ulang</button>
                    <button onclick="goToStep3()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold">Lanjut</button>
                  </div>
                </div>

                <div id="uploadArea" class="py-16 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50 max-w-md mx-auto">
                  <svg class="w-14 h-14 text-slate-300 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  <p class="text-slate-500 mb-6">Ambil foto atau upload gambar tulisan</p>
                  <div class="flex flex-col gap-3 px-6">
                    <button onclick="startCamera()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                      Buka Kamera
                    </button>
                    <label class="w-full border-2 border-slate-200 text-slate-600 py-4 rounded-xl font-bold flex items-center justify-center gap-2 cursor-pointer hover:bg-white transition-colors">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                      Upload Gambar
                      <input type="file" accept="image/*" onchange="handleFileUpload(event)" class="hidden">
                    </label>
                  </div>
                </div>
              </div>

              <!-- Text Mode -->
              <div id="textModeContent" class="hidden space-y-4">
                <div class="relative">
                  <textarea
                    id="manualText"
                    placeholder="Ketik atau paste tulisan siswa di sini..."
                    class="w-full h-64 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all resize-none"
                  ></textarea>
                  <div id="wordCount" class="absolute bottom-3 right-3 text-xs text-slate-400">0 kata</div>
                </div>
                <button 
                  onclick="goToStep3()"
                  class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2"
                >
                  Lanjut ke Analisis
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
                </button>
              </div>

              <button onclick="goToStep1()" class="text-slate-400 flex items-center justify-center gap-2 mx-auto hover:text-slate-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                Kembali
              </button>
            </div>

            <!-- Step 3: Confirm -->
            <div id="stepContent3" class="space-y-6 hidden">
              <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
                </div>
                <h2 class="text-2xl font-black text-slate-800">Konfirmasi & Analisis</h2>
                <p class="text-slate-500">Periksa data sebelum memulai analisis AI</p>
              </div>

              <div id="summaryCard" class="bg-slate-50 rounded-xl p-6 space-y-3">
                <!-- Filled dynamically -->
              </div>

              <div id="previewContainer" class="max-w-sm mx-auto">
                <!-- Preview image or text -->
              </div>

              <button 
                onclick="runAnalysis()"
                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
                Mulai Analisis AI
              </button>
              
              <button onclick="goToStep2()" class="text-slate-400 flex items-center justify-center gap-2 mx-auto hover:text-slate-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                Kembali
              </button>
            </div>

            <!-- Step 4: Results -->
            <div id="stepContent4" class="hidden">
              <div id="resultsContent">
                <!-- Filled dynamically -->
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- History Page -->
      <div id="tab-history" class="tab-content">
        <div class="max-w-5xl mx-auto animate-fadeIn">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
              <h2 class="text-2xl md:text-3xl font-black text-slate-800">Riwayat Penilaian</h2>
              <p id="historyCount" class="text-slate-500 mt-1">0 total penilaian</p>
            </div>
            <div class="relative w-full md:w-72">
              <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35"/></svg>
              <input 
                type="text"
                id="searchHistory"
                oninput="filterHistory()"
                placeholder="Cari siswa..." 
                class="w-full pl-12 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all"
              >
            </div>
          </div>
          <div id="historyList" class="space-y-4">
            <div class="text-center py-20 bg-white rounded-3xl border border-dashed border-slate-200">
              <svg class="w-14 h-14 mx-auto text-slate-200 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
              <p class="text-slate-400 font-medium">Belum ada riwayat penilaian</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Guide Page -->
      <div id="tab-guide" class="tab-content">
        <div class="max-w-4xl mx-auto animate-fadeIn">
          
          <!-- Header -->
          <div class="text-center mb-8">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
            </div>
            <h1 class="text-3xl font-black text-slate-800">Panduan Penggunaan</h1>
            <p class="text-slate-500 mt-2">Pelajari cara menggunakan English AI Scan dengan mudah</p>
          </div>

          <!-- Quick Start -->
          <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-6 md:p-8 text-white mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              Mulai Cepat (4 Langkah)
            </h2>
            <div class="grid md:grid-cols-4 gap-4">
              <div class="bg-white/20 backdrop-blur rounded-xl p-4 text-center">
                <div class="w-10 h-10 bg-white text-blue-600 rounded-full flex items-center justify-center font-black mx-auto mb-2">1</div>
                <p class="text-sm font-medium">Isi data siswa</p>
              </div>
              <div class="bg-white/20 backdrop-blur rounded-xl p-4 text-center">
                <div class="w-10 h-10 bg-white text-blue-600 rounded-full flex items-center justify-center font-black mx-auto mb-2">2</div>
                <p class="text-sm font-medium">Foto/ketik tulisan</p>
              </div>
              <div class="bg-white/20 backdrop-blur rounded-xl p-4 text-center">
                <div class="w-10 h-10 bg-white text-blue-600 rounded-full flex items-center justify-center font-black mx-auto mb-2">3</div>
                <p class="text-sm font-medium">Analisis AI</p>
              </div>
              <div class="bg-white/20 backdrop-blur rounded-xl p-4 text-center">
                <div class="w-10 h-10 bg-white text-blue-600 rounded-full flex items-center justify-center font-black mx-auto mb-2">4</div>
                <p class="text-sm font-medium">Lihat & kirim hasil</p>
              </div>
            </div>
          </div>

          <!-- Accordion Sections -->
          <div class="space-y-4">
            
            <!-- Section 1: API Key -->
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
              <button onclick="toggleAccordion('acc1')" class="w-full p-6 text-left flex items-center justify-between hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                  </div>
                  <div>
                    <h3 class="font-bold text-slate-800">Apa itu API Key & Cara Mendapatkannya</h3>
                    <p class="text-sm text-slate-500">Kunci akses untuk menggunakan AI Google Gemini</p>
                  </div>
                </div>
                <svg id="acc1-icon" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div id="acc1" class="hidden px-6 pb-6">
                <div class="bg-slate-50 rounded-xl p-6 space-y-4">
                  <div class="flex items-start gap-3">
                    <span class="text-2xl">üîë</span>
                    <div>
                      <h4 class="font-bold text-slate-800">Apa itu API Key?</h4>
                      <p class="text-sm text-slate-600">API Key adalah "kunci akses" agar aplikasi bisa menggunakan layanan AI dari Google. Seperti kartu member untuk masuk ke fasilitas tertentu.</p>
                    </div>
                  </div>
                  
                  <hr class="border-slate-200">
                  
                  <h4 class="font-bold text-slate-800">üìã Cara Mendapatkan (GRATIS):</h4>
                  <ol class="space-y-3 text-sm text-slate-600">
                    <li class="flex items-start gap-3">
                      <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">1</span>
                      <span>Buka <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-600 font-semibold hover:underline">aistudio.google.com/apikey</a></span>
                    </li>
                    <li class="flex items-start gap-3">
                      <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">2</span>
                      <span>Login dengan akun Google (Gmail) Anda</span>
                    </li>
                    <li class="flex items-start gap-3">
                      <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">3</span>
                      <span>Klik tombol <strong>"Create API Key"</strong></span>
                    </li>
                    <li class="flex items-start gap-3">
                      <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">4</span>
                      <span>Copy kode yang muncul (contoh: <code class="bg-slate-200 px-2 py-0.5 rounded">AIzaSyB123...</code>)</span>
                    </li>
                    <li class="flex items-start gap-3">
                      <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">5</span>
                      <span>Paste ke kolom "API Key" di aplikasi ini</span>
                    </li>
                  </ol>
                  
                  <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mt-4">
                    <p class="text-sm text-amber-800"><strong>‚ö†Ô∏è Penting:</strong> Jangan bagikan API Key ke orang lain. API Key tersimpan aman di browser Anda saja.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 2: Input Data Siswa -->
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
              <button onclick="toggleAccordion('acc2')" class="w-full p-6 text-left flex items-center justify-between hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                  </div>
                  <div>
                    <h3 class="font-bold text-slate-800">Mengisi Data Siswa</h3>
                    <p class="text-sm text-slate-500">Informasi yang diperlukan sebelum penilaian</p>
                  </div>
                </div>
                <svg id="acc2-icon" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div id="acc2" class="hidden px-6 pb-6">
                <div class="bg-slate-50 rounded-xl p-6">
                  <table class="w-full text-sm">
                    <thead>
                      <tr class="border-b border-slate-200">
                        <th class="text-left py-2 font-bold text-slate-800">Field</th>
                        <th class="text-left py-2 font-bold text-slate-800">Keterangan</th>
                        <th class="text-left py-2 font-bold text-slate-800">Contoh</th>
                      </tr>
                    </thead>
                    <tbody class="text-slate-600">
                      <tr class="border-b border-slate-100">
                        <td class="py-3 font-medium">Nama Siswa *</td>
                        <td class="py-3">Nama lengkap siswa</td>
                        <td class="py-3"><code class="bg-slate-200 px-2 py-0.5 rounded">Ahmad Rizki</code></td>
                      </tr>
                      <tr class="border-b border-slate-100">
                        <td class="py-3 font-medium">Kelas *</td>
                        <td class="py-3">Kelas dan jurusan</td>
                        <td class="py-3"><code class="bg-slate-200 px-2 py-0.5 rounded">X IPA 2</code></td>
                      </tr>
                      <tr class="border-b border-slate-100">
                        <td class="py-3 font-medium">WhatsApp</td>
                        <td class="py-3">Nomor WA (opsional, hanya angka)</td>
                        <td class="py-3"><code class="bg-slate-200 px-2 py-0.5 rounded">6281234567890</code></td>
                      </tr>
                      <tr class="border-b border-slate-100">
                        <td class="py-3 font-medium">Genre *</td>
                        <td class="py-3">Jenis teks yang ditulis</td>
                        <td class="py-3"><code class="bg-slate-200 px-2 py-0.5 rounded">Narrative</code></td>
                      </tr>
                      <tr>
                        <td class="py-3 font-medium">Topik</td>
                        <td class="py-3">Judul/tema tulisan (opsional)</td>
                        <td class="py-3"><code class="bg-slate-200 px-2 py-0.5 rounded">My Holiday</code></td>
                      </tr>
                    </tbody>
                  </table>
                  <p class="text-xs text-slate-500 mt-4">* Wajib diisi</p>
                </div>
              </div>
            </div>

            <!-- Section 3: Metode Input -->
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
              <button onclick="toggleAccordion('acc3')" class="w-full p-6 text-left flex items-center justify-between hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  </div>
                  <div>
                    <h3 class="font-bold text-slate-800">Metode Input Tulisan</h3>
                    <p class="text-sm text-slate-500">Scan kamera, upload gambar, atau ketik manual</p>
                  </div>
                </div>
                <svg id="acc3-icon" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div id="acc3" class="hidden px-6 pb-6">
                <div class="grid md:grid-cols-2 gap-4">
                  <div class="bg-blue-50 rounded-xl p-5 border border-blue-100">
                    <div class="flex items-center gap-3 mb-3">
                      <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/></svg>
                      </div>
                      <h4 class="font-bold text-blue-800">Scan/Upload Gambar</h4>
                    </div>
                    <ul class="text-sm text-blue-700 space-y-2">
                      <li>üì∏ <strong>Buka Kamera:</strong> Foto langsung tulisan tangan</li>
                      <li>üñºÔ∏è <strong>Upload Gambar:</strong> Pilih foto dari galeri</li>
                    </ul>
                    <div class="mt-4 p-3 bg-blue-100 rounded-lg">
                      <p class="text-xs text-blue-800"><strong>üí° Tips:</strong> Pastikan pencahayaan cukup dan tulisan terlihat jelas</p>
                    </div>
                  </div>
                  
                  <div class="bg-indigo-50 rounded-xl p-5 border border-indigo-100">
                    <div class="flex items-center gap-3 mb-3">
                      <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                      </div>
                      <h4 class="font-bold text-indigo-800">Ketik Manual</h4>
                    </div>
                    <ul class="text-sm text-indigo-700 space-y-2">
                      <li>‚å®Ô∏è Ketik langsung tulisan siswa</li>
                      <li>üìã Atau paste dari dokumen lain</li>
                    </ul>
                    <div class="mt-4 p-3 bg-indigo-100 rounded-lg">
                      <p class="text-xs text-indigo-800"><strong>üí° Tips:</strong> Cocok untuk tugas digital atau transkrip tulisan</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 4: CP & TP -->
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
              <button onclick="toggleAccordion('acc4')" class="w-full p-6 text-left flex items-center justify-between hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                  </div>
                  <div>
                    <h3 class="font-bold text-slate-800">Capaian & Tujuan Pembelajaran (CP/TP)</h3>
                    <p class="text-sm text-slate-500">Penilaian sesuai kurikulum</p>
                  </div>
                </div>
                <svg id="acc4-icon" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div id="acc4" class="hidden px-6 pb-6">
                <div class="bg-slate-50 rounded-xl p-6 space-y-4">
                  <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-white rounded-lg p-4 border border-slate-200">
                      <h4 class="font-bold text-indigo-700 mb-2">üìã Capaian Pembelajaran (CP)</h4>
                      <p class="text-sm text-slate-600">Kompetensi yang diharapkan dicapai siswa di akhir fase/tingkat. Biasanya dari dokumen kurikulum.</p>
                      <div class="mt-3 p-3 bg-indigo-50 rounded-lg text-xs text-indigo-700">
                        <strong>Contoh:</strong> Peserta didik mampu menulis teks naratif sederhana dengan memperhatikan fungsi sosial, struktur teks, dan unsur kebahasaan.
                      </div>
                    </div>
                    <div class="bg-white rounded-lg p-4 border border-slate-200">
                      <h4 class="font-bold text-purple-700 mb-2">üéØ Tujuan Pembelajaran (TP)</h4>
                      <p class="text-sm text-slate-600">Target spesifik yang harus dicapai siswa dalam satu pertemuan/unit. Lebih detail dari CP.</p>
                      <div class="mt-3 p-3 bg-purple-50 rounded-lg text-xs text-purple-700">
                        <strong>Contoh:</strong><br>
                        1. Siswa dapat menulis orientation dengan tepat<br>
                        2. Siswa dapat menggunakan simple past tense
                      </div>
                    </div>
                  </div>
                  
                  <hr class="border-slate-200">
                  
                  <h4 class="font-bold text-slate-800">‚ú® Fitur Otomatis:</h4>
                  <ul class="space-y-2 text-sm text-slate-600">
                    <li class="flex items-start gap-2">
                      <span class="text-green-500 mt-0.5">‚úì</span>
                      <span><strong>Disimpan otomatis</strong> - CP & TP yang diinput akan tersimpan untuk penilaian berikutnya</span>
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-green-500 mt-0.5">‚úì</span>
                      <span><strong>Gunakan ulang</strong> - Centang "Gunakan CP & TP sebelumnya" jika asesmen masih sama</span>
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-green-500 mt-0.5">‚úì</span>
                      <span><strong>Ganti kapan saja</strong> - Input baru jika asesmen berbeda</span>
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-green-500 mt-0.5">‚úì</span>
                      <span><strong>Penilaian kontekstual</strong> - AI akan menilai sesuai CP & TP yang diberikan</span>
                    </li>
                  </ul>
                  
                  <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <p class="text-sm text-amber-800"><strong>üí° Tips:</strong> CP & TP bersifat opsional, tapi sangat disarankan untuk penilaian yang lebih akurat dan sesuai kurikulum.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 5: Kriteria Penilaian -->
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
              <button onclick="toggleAccordion('acc5')" class="w-full p-6 text-left flex items-center justify-between hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                  </div>
                  <div>
                    <h3 class="font-bold text-slate-800">Kriteria Penilaian</h3>
                    <p class="text-sm text-slate-500">5 aspek yang dinilai oleh AI</p>
                  </div>
                </div>
                <svg id="acc5-icon" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div id="acc5" class="hidden px-6 pb-6">
                <div class="space-y-3">
                  <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-xl">
                    <div class="w-10 h-10 bg-blue-600 text-white rounded-lg flex items-center justify-center font-bold flex-shrink-0">1</div>
                    <div>
                      <h4 class="font-bold text-slate-800">Content (Isi) - 20 poin</h4>
                      <p class="text-sm text-slate-600">Relevansi, kedalaman ide, kreativitas, detail pendukung</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-xl">
                    <div class="w-10 h-10 bg-indigo-600 text-white rounded-lg flex items-center justify-center font-bold flex-shrink-0">2</div>
                    <div>
                      <h4 class="font-bold text-slate-800">Organization (Organisasi) - 20 poin</h4>
                      <p class="text-sm text-slate-600">Struktur, koherensi, transisi, pembuka & penutup</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-xl">
                    <div class="w-10 h-10 bg-purple-600 text-white rounded-lg flex items-center justify-center font-bold flex-shrink-0">3</div>
                    <div>
                      <h4 class="font-bold text-slate-800">Grammar (Tata Bahasa) - 20 poin</h4>
                      <p class="text-sm text-slate-600">Struktur kalimat, subject-verb agreement, tenses</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-xl">
                    <div class="w-10 h-10 bg-pink-600 text-white rounded-lg flex items-center justify-center font-bold flex-shrink-0">4</div>
                    <div>
                      <h4 class="font-bold text-slate-800">Vocabulary (Kosakata) - 20 poin</h4>
                      <p class="text-sm text-slate-600">Pemilihan kata, variasi, kesesuaian konteks</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-xl">
                    <div class="w-10 h-10 bg-orange-600 text-white rounded-lg flex items-center justify-center font-bold flex-shrink-0">5</div>
                    <div>
                      <h4 class="font-bold text-slate-800">Mechanics (Mekanik) - 20 poin</h4>
                      <p class="text-sm text-slate-600">Ejaan, tanda baca, kapitalisasi</p>
                    </div>
                  </div>
                </div>
                
                <div class="mt-6 p-4 bg-gradient-to-r from-emerald-50 to-blue-50 rounded-xl border border-emerald-100">
                  <h4 class="font-bold text-slate-800 mb-2">üìä Level Penilaian:</h4>
                  <div class="grid grid-cols-5 gap-2 text-center text-xs">
                    <div class="p-2 bg-red-100 text-red-700 rounded-lg font-medium">Emerging<br><span class="text-[10px]">0-39</span></div>
                    <div class="p-2 bg-amber-100 text-amber-700 rounded-lg font-medium">Developing<br><span class="text-[10px]">40-59</span></div>
                    <div class="p-2 bg-blue-100 text-blue-700 rounded-lg font-medium">Proficient<br><span class="text-[10px]">60-79</span></div>
                    <div class="p-2 bg-emerald-100 text-emerald-700 rounded-lg font-medium">Advanced<br><span class="text-[10px]">80-89</span></div>
                    <div class="p-2 bg-purple-100 text-purple-700 rounded-lg font-medium">Exemplary<br><span class="text-[10px]">90-100</span></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 6: Kirim WhatsApp -->
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
              <button onclick="toggleAccordion('acc6')" class="w-full p-6 text-left flex items-center justify-between hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                  </div>
                  <div>
                    <h3 class="font-bold text-slate-800">Mengirim Hasil via WhatsApp</h3>
                    <p class="text-sm text-slate-500">Kirim hasil penilaian ke siswa/orang tua</p>
                  </div>
                </div>
                <svg id="acc6-icon" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div id="acc6" class="hidden px-6 pb-6">
                <div class="bg-slate-50 rounded-xl p-6 space-y-4">
                  <p class="text-sm text-slate-600">Setelah penilaian selesai, Anda dapat langsung mengirim hasil ke WhatsApp siswa atau orang tua.</p>
                  
                  <h4 class="font-bold text-slate-800">üì± Format Nomor WhatsApp:</h4>
                  <div class="bg-white rounded-lg p-4 border border-slate-200">
                    <div class="flex items-center gap-3 mb-2">
                      <span class="text-green-600">‚úÖ</span>
                      <code class="bg-green-100 text-green-800 px-2 py-1 rounded">6281234567890</code>
                      <span class="text-sm text-slate-500">Benar</span>
                    </div>
                    <div class="flex items-center gap-3 mb-2">
                      <span class="text-red-600">‚ùå</span>
                      <code class="bg-red-100 text-red-800 px-2 py-1 rounded">081234567890</code>
                      <span class="text-sm text-slate-500">Tanpa kode negara</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <span class="text-red-600">‚ùå</span>
                      <code class="bg-red-100 text-red-800 px-2 py-1 rounded">+62-812-345</code>
                      <span class="text-sm text-slate-500">Ada simbol</span>
                    </div>
                  </div>
                  
                  <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <p class="text-sm text-green-800"><strong>üí° Tips:</strong> Ganti angka <strong>0</strong> di awal dengan <strong>62</strong> (kode Indonesia)</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 7: Tips -->
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
              <button onclick="toggleAccordion('acc7')" class="w-full p-6 text-left flex items-center justify-between hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                  </div>
                  <div>
                    <h3 class="font-bold text-slate-800">Tips & Trik</h3>
                    <p class="text-sm text-slate-500">Cara mendapatkan hasil terbaik</p>
                  </div>
                </div>
                <svg id="acc7-icon" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div id="acc7" class="hidden px-6 pb-6">
                <div class="grid md:grid-cols-2 gap-4">
                  <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                    <h4 class="font-bold text-blue-800 mb-2">üì∏ Tips Foto</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                      <li>‚Ä¢ Pencahayaan cukup terang</li>
                      <li>‚Ä¢ Foto dari atas (tegak lurus)</li>
                      <li>‚Ä¢ Pastikan tulisan tidak terpotong</li>
                      <li>‚Ä¢ Hindari bayangan menutupi tulisan</li>
                    </ul>
                  </div>
                  <div class="p-4 bg-purple-50 rounded-xl border border-purple-100">
                    <h4 class="font-bold text-purple-800 mb-2">‚úçÔ∏è Tips Tulisan</h4>
                    <ul class="text-sm text-purple-700 space-y-1">
                      <li>‚Ä¢ Tulis dengan tinta gelap</li>
                      <li>‚Ä¢ Gunakan kertas polos/bergaris</li>
                      <li>‚Ä¢ Tulisan harus terbaca jelas</li>
                      <li>‚Ä¢ Minimal 50 kata untuk hasil akurat</li>
                    </ul>
                  </div>
                  <div class="p-4 bg-green-50 rounded-xl border border-green-100">
                    <h4 class="font-bold text-green-800 mb-2">üéØ Tips Penilaian</h4>
                    <ul class="text-sm text-green-700 space-y-1">
                      <li>‚Ä¢ Pilih genre yang sesuai</li>
                      <li>‚Ä¢ Isi topik untuk hasil lebih relevan</li>
                      <li>‚Ä¢ Review hasil sebelum mengirim</li>
                      <li>‚Ä¢ Simpan riwayat untuk tracking</li>
                    </ul>
                  </div>
                  <div class="p-4 bg-amber-50 rounded-xl border border-amber-100">
                    <h4 class="font-bold text-amber-800 mb-2">‚ö†Ô∏è Troubleshooting</h4>
                    <ul class="text-sm text-amber-700 space-y-1">
                      <li>‚Ä¢ Error? Cek koneksi internet</li>
                      <li>‚Ä¢ Gagal analisis? Coba foto ulang</li>
                      <li>‚Ä¢ API error? Periksa API Key</li>
                      <li>‚Ä¢ Kamera tidak bisa? Izinkan akses</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

          </div>

          <!-- Footer -->
          <div class="mt-8 text-center text-sm text-slate-400">
            <p>English AI Scan v1.0 ‚Ä¢ Powered by Google Gemini AI</p>
            <p class="mt-1">Dibuat untuk membantu guru Bahasa Inggris üáÆüá©</p>
          </div>

        </div>
      </div>

      <!-- Statistics/Monitoring Page -->
      <div id="tab-stats" class="tab-content">
        <div class="max-w-5xl mx-auto animate-fadeIn">
          
          <!-- Header -->
          <div class="text-center mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            </div>
            <h1 class="text-2xl md:text-3xl font-black text-slate-800">Monitoring Penggunaan</h1>
            <p class="text-slate-500 mt-2">Statistik penggunaan aplikasi secara global</p>
          </div>

          <!-- Firebase Status -->
          <div id="firebaseStatus" class="mb-6">
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 text-center">
              <div class="flex items-center justify-center gap-2 text-amber-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                <span class="font-semibold">Firebase belum dikonfigurasi</span>
              </div>
              <p class="text-sm text-amber-600 mt-2">Untuk melihat statistik global, silakan konfigurasi Firebase terlebih dahulu.</p>
              <button onclick="toggleAccordion('firebaseSetup')" class="mt-3 text-sm text-amber-800 underline hover:no-underline">Lihat Panduan Setup Firebase</button>
            </div>
          </div>

          <!-- Firebase Setup Guide (Accordion) -->
          <div id="firebaseSetup" class="hidden mb-6">
            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
              <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-orange-500" viewBox="0 0 24 24" fill="currentColor"><path d="M3.89 15.673L6.255.461A.542.542 0 017.27.289l2.543 4.771L3.89 15.673zm16.795 3.691L18.433 5.365a.543.543 0 00-.918-.295l-14.2 14.294 7.857 4.428a1.62 1.62 0 001.587 0l7.926-4.428zM14.3 7.148l-1.82-3.482a.542.542 0 00-.96 0L3.53 17.984 14.3 7.148z"/></svg>
                Cara Setup Firebase (Gratis)
              </h3>
              
              <div class="space-y-4 text-sm text-slate-600">
                <div class="flex gap-3">
                  <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">1</span>
                  <div>
                    <p class="font-semibold text-slate-800">Buka Firebase Console</p>
                    <p>Kunjungi <a href="https://console.firebase.google.com" target="_blank" class="text-blue-600 hover:underline">console.firebase.google.com</a> dan login dengan akun Google</p>
                  </div>
                </div>
                
                <div class="flex gap-3">
                  <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">2</span>
                  <div>
                    <p class="font-semibold text-slate-800">Buat Project Baru</p>
                    <p>Klik "Add project" ‚Üí Beri nama (contoh: "english-ai-scan") ‚Üí Disable Google Analytics (opsional) ‚Üí Create</p>
                  </div>
                </div>
                
                <div class="flex gap-3">
                  <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">3</span>
                  <div>
                    <p class="font-semibold text-slate-800">Aktifkan Realtime Database</p>
                    <p>Di sidebar kiri ‚Üí Build ‚Üí Realtime Database ‚Üí Create Database ‚Üí Pilih lokasi ‚Üí Start in <strong>test mode</strong></p>
                  </div>
                </div>
                
                <div class="flex gap-3">
                  <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">4</span>
                  <div>
                    <p class="font-semibold text-slate-800">Dapatkan Konfigurasi</p>
                    <p>Di Project Overview ‚Üí Klik ikon Web (&lt;/&gt;) ‚Üí Register app ‚Üí Copy konfigurasi Firebase</p>
                  </div>
                </div>
                
                <div class="flex gap-3">
                  <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">5</span>
                  <div>
                    <p class="font-semibold text-slate-800">Edit File HTML</p>
                    <p>Buka file HTML dengan text editor, cari <code class="bg-slate-100 px-1 rounded">firebaseConfig</code> dan ganti dengan konfigurasi Anda</p>
                  </div>
                </div>
                
                <div class="bg-slate-50 rounded-lg p-4 mt-4">
                  <p class="font-mono text-xs text-slate-700">
                    const firebaseConfig = {<br>
                    &nbsp;&nbsp;apiKey: "<span class="text-green-600">AIzaSy...</span>",<br>
                    &nbsp;&nbsp;authDomain: "<span class="text-green-600">your-project</span>.firebaseapp.com",<br>
                    &nbsp;&nbsp;databaseURL: "https://<span class="text-green-600">your-project</span>-default-rtdb.firebaseio.com",<br>
                    &nbsp;&nbsp;projectId: "<span class="text-green-600">your-project</span>",<br>
                    &nbsp;&nbsp;...<br>
                    };
                  </p>
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
                  <p class="text-green-800"><strong>‚úÖ Setelah dikonfigurasi:</strong> Reload halaman ini, data penggunaan akan otomatis tersimpan dan bisa dilihat di halaman ini.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Global Stats Cards -->
          <div id="globalStatsSection" class="hidden">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
              <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center mb-4">
                  <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                </div>
                <p id="globalTotalTeachers" class="text-3xl font-black text-slate-800">-</p>
                <p class="text-sm text-slate-500">Total Guru</p>
              </div>
              <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                <div class="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center mb-4">
                  <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <p id="globalTotalAssessments" class="text-3xl font-black text-slate-800">-</p>
                <p class="text-sm text-slate-500">Total Penilaian</p>
              </div>
              <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                <div class="w-12 h-12 bg-purple-50 rounded-xl flex items-center justify-center mb-4">
                  <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                </div>
                <p id="globalTotalSchools" class="text-3xl font-black text-slate-800">-</p>
                <p class="text-sm text-slate-500">Sekolah Terdaftar</p>
              </div>
              <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                <div class="w-12 h-12 bg-amber-50 rounded-xl flex items-center justify-center mb-4">
                  <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                </div>
                <p id="globalAvgPerTeacher" class="text-3xl font-black text-slate-800">-</p>
                <p class="text-sm text-slate-500">Rata-rata/Guru</p>
              </div>
            </div>

            <!-- Level Distribution -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
              <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-6">
                <h3 class="font-bold text-slate-800 mb-4">üìä Distribusi Level</h3>
                <div id="levelDistribution" class="space-y-3">
                  <p class="text-slate-400 text-sm">Memuat data...</p>
                </div>
              </div>
              
              <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-6">
                <h3 class="font-bold text-slate-800 mb-4">üìö Distribusi Genre</h3>
                <div id="genreDistribution" class="space-y-3">
                  <p class="text-slate-400 text-sm">Memuat data...</p>
                </div>
              </div>
            </div>

            <!-- Teachers List -->
            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
              <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                <h3 class="font-bold text-slate-800">üë®‚Äçüè´ Daftar Guru Terdaftar</h3>
                <button onclick="loadGlobalStats()" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                  Refresh
                </button>
              </div>
              <div id="teachersList" class="divide-y divide-slate-50 max-h-96 overflow-y-auto">
                <div class="p-8 text-center">
                  <svg class="w-10 h-10 mx-auto text-slate-200 mb-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                  <p class="text-slate-400">Memuat data guru...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Local Stats (Fallback when Firebase not configured) -->
          <div id="localStatsSection">
            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
              <h3 class="font-bold text-slate-800 mb-4">üìä Statistik Lokal (Perangkat Ini)</h3>
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-50 rounded-xl p-4 text-center">
                  <p id="localTotalAssessments" class="text-2xl font-black text-slate-800">0</p>
                  <p class="text-xs text-slate-500">Total Penilaian</p>
                </div>
                <div class="bg-slate-50 rounded-xl p-4 text-center">
                  <p id="localAvgScore" class="text-2xl font-black text-slate-800">0</p>
                  <p class="text-xs text-slate-500">Rata-rata Skor</p>
                </div>
              </div>
              <p class="text-xs text-slate-400 mt-4 text-center">Data ini hanya dari perangkat ini. Untuk monitoring global, silakan setup Firebase.</p>
            </div>
          </div>

        </div>
      </div>

      <!-- Settings Page -->
      <div id="tab-settings" class="tab-content">
        <div class="max-w-md mx-auto animate-fadeIn">
          <div class="bg-white rounded-3xl p-8 shadow-xl border border-slate-100">
            <h2 class="text-2xl font-black text-slate-800 mb-6">Pengaturan Profil</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-slate-600 mb-2">Nama Lengkap</label>
                <input 
                  type="text"
                  id="settingsName" 
                  class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all"
                >
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-600 mb-2">Nama Sekolah</label>
                <input 
                  type="text"
                  id="settingsSchool" 
                  class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all"
                >
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-600 mb-2">API Key</label>
                <input 
                  type="password"
                  id="settingsApiKey" 
                  class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all"
                >
              </div>
              <button 
                onclick="updateProfile()"
                class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-colors"
              >
                Simpan Perubahan
              </button>
              <button 
                onclick="clearAllData()"
                class="w-full border-2 border-red-200 text-red-600 py-4 rounded-xl font-bold hover:bg-red-50 transition-colors"
              >
                Hapus Semua Data
              </button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Canvas for camera capture -->
  <canvas id="canvas" class="hidden"></canvas>

  <script>
    // ==================== FIREBASE CONFIGURATION ====================
    // GANTI dengan konfigurasi Firebase Anda sendiri
    // Cara mendapatkan: https://console.firebase.google.com
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    
    // Initialize Firebase
    let firebaseApp = null;
    let database = null;
    let isFirebaseConfigured = false;
    
    function initFirebase() {
      try {
        if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
          firebaseApp = firebase.initializeApp(firebaseConfig);
          database = firebase.database();
          isFirebaseConfigured = true;
          console.log('Firebase initialized successfully');
        }
      } catch (error) {
        console.log('Firebase not configured:', error);
      }
    }
    
    // ==================== ANALYTICS & TRACKING ====================
    // Generate unique user ID
    function getUserId() {
      let userId = localStorage.getItem('appUserId');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('appUserId', userId);
      }
      return userId;
    }
    
    // Track teacher registration to Firebase
    async function trackTeacherRegistration(teacherData) {
      if (!isFirebaseConfigured || !database) return;
      
      try {
        const userId = getUserId();
        const teacherRef = database.ref('teachers/' + userId);
        
        await teacherRef.set({
          name: teacherData.name,
          school: teacherData.school,
          registeredAt: new Date().toISOString(),
          lastActive: new Date().toISOString(),
          totalAssessments: 0
        });
        
        // Increment total teachers counter
        const counterRef = database.ref('stats/totalTeachers');
        counterRef.transaction((current) => (current || 0) + 1);
        
        console.log('Teacher registered to Firebase');
      } catch (error) {
        console.log('Firebase tracking error:', error);
      }
    }
    
    // Track assessment completion to Firebase
    async function trackAssessmentToFirebase(assessmentData) {
      if (!isFirebaseConfigured || !database) return;
      
      try {
        const userId = getUserId();
        
        // Update teacher's last active and increment assessment count
        const teacherRef = database.ref('teachers/' + userId);
        teacherRef.update({
          lastActive: new Date().toISOString()
        });
        teacherRef.child('totalAssessments').transaction((current) => (current || 0) + 1);
        
        // Increment total assessments counter
        const counterRef = database.ref('stats/totalAssessments');
        counterRef.transaction((current) => (current || 0) + 1);
        
        // Track by date for daily stats
        const today = new Date().toISOString().split('T')[0];
        const dailyRef = database.ref('dailyStats/' + today + '/assessments');
        dailyRef.transaction((current) => (current || 0) + 1);
        
        // Track by level distribution
        const levelRef = database.ref('stats/levelDistribution/' + assessmentData.level);
        levelRef.transaction((current) => (current || 0) + 1);
        
        // Track by genre
        const genreRef = database.ref('stats/genreDistribution/' + assessmentData.genre);
        genreRef.transaction((current) => (current || 0) + 1);
        
        console.log('Assessment tracked to Firebase');
      } catch (error) {
        console.log('Firebase tracking error:', error);
      }
    }
    
    // Get global stats from Firebase
    async function getGlobalStats() {
      if (!isFirebaseConfigured || !database) return null;
      
      try {
        const statsRef = database.ref('stats');
        const snapshot = await statsRef.once('value');
        return snapshot.val();
      } catch (error) {
        console.log('Firebase get stats error:', error);
        return null;
      }
    }
    
    // Get all teachers list (for admin)
    async function getAllTeachers() {
      if (!isFirebaseConfigured || !database) return [];
      
      try {
        const teachersRef = database.ref('teachers');
        const snapshot = await teachersRef.once('value');
        const data = snapshot.val();
        if (!data) return [];
        
        return Object.entries(data).map(([id, teacher]) => ({
          id,
          ...teacher
        }));
      } catch (error) {
        console.log('Firebase get teachers error:', error);
        return [];
      }
    }
    
    // Get daily stats
    async function getDailyStats(days = 7) {
      if (!isFirebaseConfigured || !database) return [];
      
      try {
        const dailyRef = database.ref('dailyStats');
        const snapshot = await dailyRef.limitToLast(days).once('value');
        const data = snapshot.val();
        if (!data) return [];
        
        return Object.entries(data).map(([date, stats]) => ({
          date,
          ...stats
        }));
      } catch (error) {
        console.log('Firebase get daily stats error:', error);
        return [];
      }
    }

    // ==================== STATE ====================
    let state = {
      profile: { name: '', school: '', apiKey: '', isSet: false },
      history: [],
      currentStep: 1,
      inputMode: 'camera',
      capturedImage: null,
      currentAssessment: null,
      videoStream: null,
      lastCPTP: { cp: '', tp: '' } // Store last used CP & TP
    };

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
      loadState();
      
      // Word count for textarea
      document.getElementById('manualText').addEventListener('input', function() {
        const words = this.value.trim().split(/\s+/).filter(w => w).length;
        document.getElementById('wordCount').textContent = words + ' kata';
      });
    });

    function loadState() {
      // Initialize Firebase
      initFirebase();
      
      const savedProfile = localStorage.getItem('teacherProfile');
      const savedHistory = localStorage.getItem('assessmentHistory');
      const savedCPTP = localStorage.getItem('lastCPTP');
      
      if (savedProfile) {
        state.profile = JSON.parse(savedProfile);
      }
      
      if (savedHistory) {
        state.history = JSON.parse(savedHistory);
      }
      
      if (savedCPTP) {
        state.lastCPTP = JSON.parse(savedCPTP);
      }
      
      if (state.profile.isSet) {
        showTab('dashboard');
        updateUI();
      } else {
        showTab('setup');
      }
    }

    function saveState() {
      localStorage.setItem('teacherProfile', JSON.stringify(state.profile));
      localStorage.setItem('assessmentHistory', JSON.stringify(state.history));
    }

    // ==================== NOTIFICATIONS ====================
    function showNotification(message, type = 'success') {
      const el = document.getElementById('notification');
      el.textContent = message;
      el.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-xl shadow-xl text-white font-medium animate-slideIn ${type === 'error' ? 'bg-red-500' : 'bg-emerald-500'}`;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    // ==================== NAVIGATION ====================
    function showTab(tabId) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Reset nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
        btn.classList.add('text-slate-400');
      });
      
      // Show selected tab
      const targetTab = document.getElementById('tab-' + tabId);
      if (targetTab) {
        targetTab.classList.add('active');
      }
      
      // Highlight nav button
      const navBtn = document.getElementById('nav-' + tabId);
      if (navBtn) {
        navBtn.classList.remove('text-slate-400');
        navBtn.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
      }
      
      // Update UI for specific tabs
      if (tabId === 'dashboard') updateDashboard();
      if (tabId === 'history') updateHistoryList();
      if (tabId === 'settings') loadSettings();
      if (tabId === 'new') resetAssessment();
      if (tabId === 'stats') loadGlobalStats();
    }
    
    // Load and display global stats
    async function loadGlobalStats() {
      // Update local stats first
      updateLocalStats();
      
      // Check if Firebase is configured
      if (!isFirebaseConfigured) {
        document.getElementById('firebaseStatus').classList.remove('hidden');
        document.getElementById('globalStatsSection').classList.add('hidden');
        document.getElementById('localStatsSection').classList.remove('hidden');
        return;
      }
      
      // Hide Firebase warning, show global stats
      document.getElementById('firebaseStatus').classList.add('hidden');
      document.getElementById('globalStatsSection').classList.remove('hidden');
      document.getElementById('localStatsSection').classList.add('hidden');
      
      try {
        // Get global stats
        const stats = await getGlobalStats();
        
        if (stats) {
          document.getElementById('globalTotalTeachers').textContent = stats.totalTeachers || 0;
          document.getElementById('globalTotalAssessments').textContent = stats.totalAssessments || 0;
          
          // Calculate schools and avg
          const teachers = await getAllTeachers();
          const uniqueSchools = new Set(teachers.map(t => t.school)).size;
          document.getElementById('globalTotalSchools').textContent = uniqueSchools;
          
          const avgPerTeacher = stats.totalTeachers > 0 
            ? Math.round((stats.totalAssessments || 0) / stats.totalTeachers) 
            : 0;
          document.getElementById('globalAvgPerTeacher').textContent = avgPerTeacher;
          
          // Level distribution
          if (stats.levelDistribution) {
            const levelHTML = Object.entries(stats.levelDistribution)
              .sort((a, b) => b[1] - a[1])
              .map(([level, count]) => {
                const total = Object.values(stats.levelDistribution).reduce((a, b) => a + b, 0);
                const percentage = Math.round((count / total) * 100);
                return `
                  <div class="flex items-center gap-3">
                    <span class="text-sm font-medium text-slate-600 w-24">${level}</span>
                    <div class="flex-1 h-3 bg-slate-100 rounded-full overflow-hidden">
                      <div class="h-full ${getLevelBarColor(level)}" style="width: ${percentage}%"></div>
                    </div>
                    <span class="text-xs text-slate-500 w-16 text-right">${count} (${percentage}%)</span>
                  </div>
                `;
              }).join('');
            document.getElementById('levelDistribution').innerHTML = levelHTML || '<p class="text-slate-400 text-sm">Belum ada data</p>';
          }
          
          // Genre distribution
          if (stats.genreDistribution) {
            const genreHTML = Object.entries(stats.genreDistribution)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 5) // Top 5
              .map(([genre, count]) => {
                const total = Object.values(stats.genreDistribution).reduce((a, b) => a + b, 0);
                const percentage = Math.round((count / total) * 100);
                return `
                  <div class="flex items-center gap-3">
                    <span class="text-sm font-medium text-slate-600 w-24 truncate">${genre}</span>
                    <div class="flex-1 h-3 bg-slate-100 rounded-full overflow-hidden">
                      <div class="h-full bg-indigo-500" style="width: ${percentage}%"></div>
                    </div>
                    <span class="text-xs text-slate-500 w-16 text-right">${count} (${percentage}%)</span>
                  </div>
                `;
              }).join('');
            document.getElementById('genreDistribution').innerHTML = genreHTML || '<p class="text-slate-400 text-sm">Belum ada data</p>';
          }
          
          // Teachers list
          if (teachers && teachers.length > 0) {
            const teachersHTML = teachers
              .sort((a, b) => new Date(b.lastActive) - new Date(a.lastActive))
              .map(teacher => `
                <div class="p-4 flex items-center justify-between hover:bg-slate-50">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                      ${teacher.name ? teacher.name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <div>
                      <p class="font-semibold text-slate-800">${teacher.name || 'Unknown'}</p>
                      <p class="text-xs text-slate-500">${teacher.school || '-'}</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="text-sm font-bold text-slate-800">${teacher.totalAssessments || 0} penilaian</p>
                    <p class="text-xs text-slate-400">Aktif: ${formatDate(teacher.lastActive)}</p>
                  </div>
                </div>
              `).join('');
            document.getElementById('teachersList').innerHTML = teachersHTML;
          } else {
            document.getElementById('teachersList').innerHTML = '<div class="p-8 text-center text-slate-400">Belum ada guru terdaftar</div>';
          }
        }
      } catch (error) {
        console.log('Error loading global stats:', error);
        document.getElementById('teachersList').innerHTML = '<div class="p-8 text-center text-red-400">Gagal memuat data</div>';
      }
    }
    
    function updateLocalStats() {
      document.getElementById('localTotalAssessments').textContent = state.history.length;
      const avgScore = state.history.length > 0 
        ? Math.round(state.history.reduce((a, b) => a + b.score, 0) / state.history.length)
        : 0;
      document.getElementById('localAvgScore').textContent = avgScore;
    }
    
    function getLevelBarColor(level) {
      const colors = {
        'Exemplary': 'bg-purple-500',
        'Advanced': 'bg-emerald-500',
        'Proficient': 'bg-blue-500',
        'Developing': 'bg-amber-500',
        'Emerging': 'bg-red-400'
      };
      return colors[level] || 'bg-slate-400';
    }
    
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'Baru saja';
      if (diffMins < 60) return `${diffMins} menit lalu`;
      if (diffHours < 24) return `${diffHours} jam lalu`;
      if (diffDays < 7) return `${diffDays} hari lalu`;
      return date.toLocaleDateString('id-ID');
    }

    // ==================== PROFILE ====================
    function saveProfile() {
      const name = document.getElementById('setupName').value.trim();
      const school = document.getElementById('setupSchool').value.trim();
      const apiKey = document.getElementById('setupApiKey').value.trim();
      
      if (!name || !school || !apiKey) {
        showNotification('Mohon lengkapi semua field', 'error');
        return;
      }
      
      const isNewTeacher = !state.profile.isSet;
      
      state.profile = { name, school, apiKey, isSet: true };
      saveState();
      updateUI();
      showTab('dashboard');
      showNotification('Profil berhasil disimpan!');
      
      // Track teacher registration to Firebase (only for new teachers)
      if (isNewTeacher) {
        trackTeacherRegistration({ name, school });
      }
    }

    function updateProfile() {
      const name = document.getElementById('settingsName').value.trim();
      const school = document.getElementById('settingsSchool').value.trim();
      const apiKey = document.getElementById('settingsApiKey').value.trim();
      
      if (!name || !school || !apiKey) {
        showNotification('Mohon lengkapi semua field', 'error');
        return;
      }
      
      state.profile = { name, school, apiKey, isSet: true };
      saveState();
      updateUI();
      showNotification('Profil berhasil diperbarui!');
    }

    function loadSettings() {
      document.getElementById('settingsName').value = state.profile.name || '';
      document.getElementById('settingsSchool').value = state.profile.school || '';
      document.getElementById('settingsApiKey').value = state.profile.apiKey || '';
    }

    function clearAllData() {
      if (confirm('Hapus semua data? Tindakan ini tidak dapat dibatalkan.')) {
        localStorage.clear();
        location.reload();
      }
    }

    // ==================== UI UPDATES ====================
    function updateUI() {
      // Header
      if (state.profile.isSet) {
        document.getElementById('headerProfile').classList.remove('hidden');
        document.getElementById('headerName').textContent = state.profile.name;
        document.getElementById('headerSchool').textContent = state.profile.school;
      }
    }

    function updateDashboard() {
      document.getElementById('welcomeName').textContent = state.profile.name;
      document.getElementById('welcomeSchool').textContent = state.profile.school;
      
      // Stats
      const total = state.history.length;
      const avg = total > 0 ? Math.round(state.history.reduce((a, b) => a + b.score, 0) / total) : 0;
      
      const levelCounts = {};
      state.history.forEach(h => {
        levelCounts[h.level] = (levelCounts[h.level] || 0) + 1;
      });
      const topLevel = Object.entries(levelCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || '-';
      
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
      const thisWeek = state.history.filter(h => new Date(h.timestamp) > oneWeekAgo).length;
      
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statAvg').textContent = avg;
      document.getElementById('statTop').textContent = topLevel;
      document.getElementById('statWeek').textContent = thisWeek;
      
      // Recent list
      const recentList = document.getElementById('recentList');
      if (state.history.length === 0) {
        recentList.innerHTML = `
          <div class="p-12 text-center">
            <svg class="w-12 h-12 mx-auto text-slate-200 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
            <p class="text-slate-400">Belum ada penilaian</p>
          </div>
        `;
      } else {
        recentList.innerHTML = state.history.slice(0, 5).map(item => `
          <div class="p-4 md:p-6 flex items-center justify-between hover:bg-slate-50 cursor-pointer" onclick="viewDetail('${item.id}')">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-xl flex items-center justify-center font-black text-lg ${getScoreColorClass(item.score)}">
                ${item.score}
              </div>
              <div>
                <h4 class="font-bold text-slate-800">${item.student}</h4>
                <p class="text-xs text-slate-400">${item.class} ‚Ä¢ ${item.genre} ‚Ä¢ ${item.date}</p>
              </div>
            </div>
            <span class="text-xs font-bold px-3 py-1 rounded-full border ${getLevelColorClass(item.level)}">${item.level}</span>
          </div>
        `).join('');
      }
    }

    function updateHistoryList() {
      document.getElementById('historyCount').textContent = state.history.length + ' total penilaian';
      filterHistory();
    }

    function filterHistory() {
      const query = document.getElementById('searchHistory').value.toLowerCase();
      const filtered = state.history.filter(h => 
        h.student.toLowerCase().includes(query) ||
        h.class.toLowerCase().includes(query) ||
        h.genre.toLowerCase().includes(query)
      );
      
      const historyList = document.getElementById('historyList');
      if (filtered.length === 0) {
        historyList.innerHTML = `
          <div class="text-center py-20 bg-white rounded-3xl border border-dashed border-slate-200">
            <svg class="w-14 h-14 mx-auto text-slate-200 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
            <p class="text-slate-400 font-medium">${query ? 'Tidak ditemukan' : 'Belum ada riwayat'}</p>
          </div>
        `;
      } else {
        historyList.innerHTML = filtered.map(item => `
          <div class="bg-white p-5 md:p-6 rounded-2xl border border-slate-100 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4 hover:shadow-md transition-all">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-2xl flex items-center justify-center font-black text-xl ${getScoreColorClass(item.score)}">
                ${item.score}
              </div>
              <div>
                <h4 class="font-bold text-slate-800 text-lg">${item.student}</h4>
                <p class="text-sm text-slate-500">${item.class} ‚Ä¢ ${item.genre} ‚Ä¢ ${item.date}</p>
              </div>
            </div>
            <div class="flex items-center gap-3 ml-20 md:ml-0">
              <span class="text-xs font-bold px-4 py-1.5 rounded-full border ${getLevelColorClass(item.level)}">${item.level}</span>
              <button onclick="viewDetail('${item.id}')" class="p-2 hover:bg-blue-50 rounded-lg text-blue-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
              </button>
              <button onclick="deleteHistory('${item.id}')" class="p-2 hover:bg-red-50 rounded-lg text-red-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>
          </div>
        `).join('');
      }
    }

    function viewDetail(id) {
      const item = state.history.find(h => h.id == id);
      if (!item) return;
      
      state.currentAssessment = item;
      showTab('new');
      showResults(item);
    }

    function deleteHistory(id) {
      if (confirm('Hapus penilaian ini?')) {
        state.history = state.history.filter(h => h.id != id);
        saveState();
        updateHistoryList();
        showNotification('Penilaian dihapus');
      }
    }

    // ==================== ASSESSMENT FLOW ====================
    function startNewAssessment() {
      resetAssessment();
      showTab('new');
    }

    function resetAssessment() {
      state.currentStep = 1;
      state.capturedImage = null;
      state.currentAssessment = null;
      
      // Reset form fields
      document.getElementById('studentName').value = '';
      document.getElementById('studentClass').value = '';
      document.getElementById('studentWhatsapp').value = '';
      document.getElementById('studentGenre').value = 'Narrative';
      document.getElementById('studentTopic').value = '';
      document.getElementById('manualText').value = '';
      document.getElementById('wordCount').textContent = '0 kata';
      
      // Reset CP/TP fields
      document.getElementById('capaianPembelajaran').value = '';
      document.getElementById('tujuanPembelajaran').value = '';
      document.getElementById('usePreviousCPTP').checked = false;
      
      // Check if there's previous CP/TP
      if (state.lastCPTP.cp || state.lastCPTP.tp) {
        document.getElementById('previousCPTPOption').classList.remove('hidden');
        const preview = [];
        if (state.lastCPTP.cp) {
          preview.push('CP: ' + state.lastCPTP.cp.substring(0, 50) + (state.lastCPTP.cp.length > 50 ? '...' : ''));
        }
        if (state.lastCPTP.tp) {
          preview.push('TP: ' + state.lastCPTP.tp.substring(0, 50) + (state.lastCPTP.tp.length > 50 ? '...' : ''));
        }
        document.getElementById('previousCPTPPreview').textContent = preview.join(' | ');
        document.getElementById('cptpFields').classList.remove('hidden');
      } else {
        document.getElementById('previousCPTPOption').classList.add('hidden');
        document.getElementById('cptpFields').classList.remove('hidden');
      }
      
      // Reset UI
      clearImage();
      setInputMode('camera');
      updateStepUI();
      showStepContent(1);
    }
    
    function toggleCPTPFields() {
      const usePrevious = document.getElementById('usePreviousCPTP').checked;
      const fields = document.getElementById('cptpFields');
      
      if (usePrevious) {
        fields.classList.add('hidden');
        // Set values from previous
        document.getElementById('capaianPembelajaran').value = state.lastCPTP.cp;
        document.getElementById('tujuanPembelajaran').value = state.lastCPTP.tp;
      } else {
        fields.classList.remove('hidden');
        // Clear values so user can input new ones
        document.getElementById('capaianPembelajaran').value = '';
        document.getElementById('tujuanPembelajaran').value = '';
      }
    }

    function updateStepUI() {
      for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById('step' + i);
        const lineEl = document.getElementById('line' + i);
        
        if (i <= state.currentStep) {
          stepEl.classList.remove('bg-slate-100', 'text-slate-400');
          stepEl.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
        } else {
          stepEl.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
          stepEl.classList.add('bg-slate-100', 'text-slate-400');
        }
        
        if (lineEl) {
          if (i < state.currentStep) {
            lineEl.classList.remove('bg-slate-100');
            lineEl.classList.add('bg-blue-600');
          } else {
            lineEl.classList.remove('bg-blue-600');
            lineEl.classList.add('bg-slate-100');
          }
        }
      }
    }

    function showStepContent(step) {
      for (let i = 1; i <= 4; i++) {
        document.getElementById('stepContent' + i).classList.add('hidden');
      }
      document.getElementById('stepContent' + step).classList.remove('hidden');
    }

    function goToStep1() {
      state.currentStep = 1;
      updateStepUI();
      showStepContent(1);
    }

    function goToStep2() {
      const name = document.getElementById('studentName').value.trim();
      const studentClass = document.getElementById('studentClass').value.trim();
      
      if (!name || !studentClass) {
        showNotification('Mohon isi nama dan kelas siswa', 'error');
        return;
      }
      
      state.currentStep = 2;
      updateStepUI();
      showStepContent(2);
    }

    function goToStep3() {
      if (state.inputMode === 'camera' && !state.capturedImage) {
        showNotification('Mohon ambil foto atau upload gambar', 'error');
        return;
      }
      
      if (state.inputMode === 'text' && !document.getElementById('manualText').value.trim()) {
        showNotification('Mohon masukkan teks tulisan siswa', 'error');
        return;
      }
      
      state.currentStep = 3;
      updateStepUI();
      showStepContent(3);
      updateSummary();
    }

    function updateSummary() {
      const name = document.getElementById('studentName').value.trim();
      const studentClass = document.getElementById('studentClass').value.trim();
      const genre = document.getElementById('studentGenre').value;
      const topic = document.getElementById('studentTopic').value.trim();
      const cp = document.getElementById('capaianPembelajaran').value.trim();
      const tp = document.getElementById('tujuanPembelajaran').value.trim();
      
      let summaryHTML = `
        <div class="flex justify-between items-center py-2 border-b border-slate-200">
          <span class="text-slate-500">Nama Siswa</span>
          <span class="font-bold text-slate-800">${name}</span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-slate-200">
          <span class="text-slate-500">Kelas</span>
          <span class="font-bold text-slate-800">${studentClass}</span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-slate-200">
          <span class="text-slate-500">Genre</span>
          <span class="font-bold text-slate-800">${genre}</span>
        </div>
      `;
      
      if (topic) {
        summaryHTML += `
        <div class="flex justify-between items-center py-2 border-b border-slate-200">
          <span class="text-slate-500">Topik</span>
          <span class="font-bold text-slate-800">${topic}</span>
        </div>
        `;
      }
      
      summaryHTML += `
        <div class="flex justify-between items-center py-2 ${(cp || tp) ? 'border-b border-slate-200' : ''}">
          <span class="text-slate-500">Metode</span>
          <span class="font-bold text-slate-800">${state.inputMode === 'camera' ? 'Scan/Upload' : 'Teks Manual'}</span>
        </div>
      `;
      
      if (cp || tp) {
        summaryHTML += `
        <div class="pt-3 mt-2">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
            <span class="text-xs font-semibold text-indigo-600">CP & TP Tersedia</span>
          </div>
        `;
        
        if (cp) {
          summaryHTML += `
          <div class="text-xs text-slate-600 mb-1">
            <span class="font-semibold">CP:</span> ${cp.length > 80 ? cp.substring(0, 80) + '...' : cp}
          </div>
          `;
        }
        
        if (tp) {
          summaryHTML += `
          <div class="text-xs text-slate-600">
            <span class="font-semibold">TP:</span> ${tp.length > 80 ? tp.substring(0, 80) + '...' : tp}
          </div>
          `;
        }
        
        summaryHTML += `</div>`;
      }
      
      document.getElementById('summaryCard').innerHTML = summaryHTML;
      
      const previewContainer = document.getElementById('previewContainer');
      if (state.inputMode === 'camera' && state.capturedImage) {
        previewContainer.innerHTML = `<img src="${state.capturedImage}" class="w-full rounded-xl shadow-lg" alt="Preview">`;
      } else if (state.inputMode === 'text') {
        const text = document.getElementById('manualText').value.trim();
        previewContainer.innerHTML = `<div class="bg-white border border-slate-200 rounded-xl p-4 max-h-40 overflow-auto text-sm text-slate-600">${text}</div>`;
      }
    }

    // ==================== INPUT MODE ====================
    function setInputMode(mode) {
      state.inputMode = mode;
      
      if (mode === 'camera') {
        document.getElementById('modeCamera').classList.add('bg-white', 'shadow-md', 'text-blue-600');
        document.getElementById('modeCamera').classList.remove('text-slate-500');
        document.getElementById('modeText').classList.remove('bg-white', 'shadow-md', 'text-blue-600');
        document.getElementById('modeText').classList.add('text-slate-500');
        document.getElementById('cameraModeContent').classList.remove('hidden');
        document.getElementById('textModeContent').classList.add('hidden');
      } else {
        document.getElementById('modeText').classList.add('bg-white', 'shadow-md', 'text-blue-600');
        document.getElementById('modeText').classList.remove('text-slate-500');
        document.getElementById('modeCamera').classList.remove('bg-white', 'shadow-md', 'text-blue-600');
        document.getElementById('modeCamera').classList.add('text-slate-500');
        document.getElementById('textModeContent').classList.remove('hidden');
        document.getElementById('cameraModeContent').classList.add('hidden');
      }
    }

    // ==================== CAMERA ====================
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
        });
        
        state.videoStream = stream;
        const video = document.getElementById('videoPreview');
        video.srcObject = stream;
        
        document.getElementById('uploadArea').classList.add('hidden');
        document.getElementById('cameraPreview').classList.remove('hidden');
      } catch (err) {
        console.error(err);
        showNotification('Tidak dapat mengakses kamera', 'error');
      }
    }

    function stopCamera() {
      if (state.videoStream) {
        state.videoStream.getTracks().forEach(track => track.stop());
        state.videoStream = null;
      }
      document.getElementById('cameraPreview').classList.add('hidden');
      document.getElementById('uploadArea').classList.remove('hidden');
    }

    function capturePhoto() {
      const video = document.getElementById('videoPreview');
      const canvas = document.getElementById('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      
      state.capturedImage = canvas.toDataURL('image/jpeg', 0.9);
      
      stopCamera();
      showCapturedImage();
      showNotification('Foto berhasil diambil!');
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onloadend = function() {
          state.capturedImage = reader.result;
          showCapturedImage();
          showNotification('Gambar berhasil diunggah!');
        };
        reader.readAsDataURL(file);
      }
    }

    function showCapturedImage() {
      document.getElementById('capturedImage').src = state.capturedImage;
      document.getElementById('uploadArea').classList.add('hidden');
      document.getElementById('imagePreview').classList.remove('hidden');
    }

    function clearImage() {
      state.capturedImage = null;
      document.getElementById('imagePreview').classList.add('hidden');
      document.getElementById('uploadArea').classList.remove('hidden');
    }

    // ==================== AI ANALYSIS ====================
    async function runAnalysis() {
      if (!state.profile.apiKey) {
        showNotification('API Key tidak ditemukan', 'error');
        return;
      }
      
      document.getElementById('loadingOverlay').classList.remove('hidden');
      document.getElementById('loadingOverlay').classList.add('flex');
      
      try {
        const studentName = document.getElementById('studentName').value.trim();
        const studentClass = document.getElementById('studentClass').value.trim();
        const genre = document.getElementById('studentGenre').value;
        const topic = document.getElementById('studentTopic').value.trim();
        const whatsapp = document.getElementById('studentWhatsapp').value.trim();
        const cp = document.getElementById('capaianPembelajaran').value.trim();
        const tp = document.getElementById('tujuanPembelajaran').value.trim();
        
        // Save CP/TP to state and localStorage for future use
        if (cp || tp) {
          state.lastCPTP = { cp, tp };
          localStorage.setItem('lastCPTP', JSON.stringify(state.lastCPTP));
        }
        
        // Build context with CP and TP
        let contextInfo = `Context:
- Student Name: ${studentName}
- Class: ${studentClass}
- Writing Genre: ${genre}
- Topic: ${topic || 'Free Topic'}`;

        if (cp) {
          contextInfo += `
- Capaian Pembelajaran (Learning Outcomes): ${cp}`;
        }
        
        if (tp) {
          contextInfo += `
- Tujuan Pembelajaran (Learning Objectives): ${tp}`;
        }
        
        let requestBody;
        const systemPrompt = `You are an expert English Teacher. Assess the writing based on these criteria (each 0-20):
1. Content: Relevance, depth, creativity
2. Organization: Structure, coherence, transitions
3. Grammar: Sentence structure, tenses
4. Vocabulary: Word choice, variety
5. Mechanics: Spelling, punctuation

${contextInfo}

${(cp || tp) ? `IMPORTANT: Align your assessment and feedback with the provided Capaian Pembelajaran (CP) and Tujuan Pembelajaran (TP). Evaluate how well the student achieves the stated learning objectives.` : ''}

Return ONLY valid JSON:
{
  "extractedText": "the text content",
  "wordCount": number,
  "sentenceCount": number,
  "scores": {"content": 0-20, "organization": 0-20, "grammar": 0-20, "vocabulary": 0-20, "mechanics": 0-20},
  "totalScore": 0-100,
  "level": "Emerging/Developing/Proficient/Advanced/Exemplary",
  "strengths": ["strength1", "strength2", "strength3"],
  "improvements": ["area1", "area2", "area3"],
  "teacherNote": "encouraging message",
  "suggestedActivities": ["activity1", "activity2"]${(cp || tp) ? `,
  "cpAchievement": "brief assessment of how well student meets the Capaian Pembelajaran",
  "tpAchievement": "brief assessment of which Tujuan Pembelajaran are met and which need improvement"` : ''}
}`;

        if (state.inputMode === 'camera') {
          const base64Data = state.capturedImage.split(',')[1];
          requestBody = {
            contents: [{
              parts: [
                { text: systemPrompt },
                { inlineData: { mimeType: "image/jpeg", data: base64Data } }
              ]
            }],
            generationConfig: { responseMimeType: "application/json", temperature: 0.3 }
          };
        } else {
          const manualText = document.getElementById('manualText').value.trim();
          requestBody = {
            contents: [{
              parts: [{ text: systemPrompt + "\n\nText to assess:\n" + manualText }]
            }],
            generationConfig: { responseMimeType: "application/json", temperature: 0.3 }
          };
        }
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-04-17:generateContent?key=${state.profile.apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message);
        }
        
        const result = JSON.parse(data.candidates[0].content.parts[0].text);
        
        // Save to history
        const newEntry = {
          id: Date.now(),
          date: new Date().toLocaleDateString('id-ID'),
          timestamp: new Date().toISOString(),
          student: studentName,
          class: studentClass,
          whatsapp: whatsapp,
          genre: genre,
          topic: topic,
          score: result.totalScore,
          level: result.level,
          scores: result.scores,
          strengths: result.strengths,
          improvements: result.improvements,
          teacherNote: result.teacherNote,
          suggestedActivities: result.suggestedActivities,
          writingText: result.extractedText,
          wordCount: result.wordCount,
          sentenceCount: result.sentenceCount,
          // CP & TP data
          capaianPembelajaran: cp,
          tujuanPembelajaran: tp,
          cpAchievement: result.cpAchievement || null,
          tpAchievement: result.tpAchievement || null
        };
        
        state.history.unshift(newEntry);
        state.currentAssessment = newEntry;
        saveState();
        
        // Track assessment completed to Firebase
        trackAssessmentToFirebase({
          genre: genre,
          score: result.totalScore,
          level: result.level
        });
        
        state.currentStep = 4;
        updateStepUI();
        showResults(newEntry);
        showNotification('Analisis selesai!');
        
      } catch (error) {
        console.error(error);
        showNotification('Analisis gagal: ' + error.message, 'error');
      } finally {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('loadingOverlay').classList.remove('flex');
      }
    }

    function showResults(item) {
      state.currentStep = 4;
      updateStepUI();
      showStepContent(4);
      
      const resultsContent = document.getElementById('resultsContent');
      resultsContent.innerHTML = `
        <div class="text-center mb-8">
          <div class="w-28 h-28 rounded-3xl flex flex-col items-center justify-center mx-auto mb-4 shadow-2xl ${getScoreColorClass(item.score)}">
            <span class="text-4xl font-black">${item.score}</span>
            <span class="text-xs font-bold opacity-70">/100</span>
          </div>
          <span class="inline-block px-6 py-2 rounded-full font-bold text-sm border ${getLevelColorClass(item.level)}">${item.level}</span>
          <h3 class="text-xl font-bold text-slate-800 mt-4">${item.student}</h3>
          <p class="text-slate-500">${item.class} ‚Ä¢ ${item.genre}</p>
        </div>
        
        <div class="grid md:grid-cols-2 gap-6">
          <div class="space-y-6">
            <div class="bg-slate-50 rounded-xl p-5">
              <h4 class="font-bold text-slate-700 mb-3">üìù Teks Terdeteksi</h4>
              <p class="text-slate-600 text-sm italic">"${item.writingText}"</p>
              <div class="flex gap-4 mt-3 text-xs text-slate-400">
                <span>${item.wordCount} kata</span>
                <span>${item.sentenceCount} kalimat</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-5 border">
              <h4 class="font-bold text-slate-700 mb-4">üìä Detail Skor</h4>
              <div class="space-y-3">
                ${Object.entries(item.scores).map(([key, value]) => `
                  <div>
                    <div class="flex justify-between items-center mb-1">
                      <span class="text-sm text-slate-600 capitalize">${key}</span>
                      <span class="text-sm font-bold text-slate-800">${value}/20</span>
                    </div>
                    <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                      <div class="h-full rounded-full ${value >= 16 ? 'bg-emerald-500' : value >= 12 ? 'bg-blue-500' : value >= 8 ? 'bg-amber-500' : 'bg-red-500'}" style="width: ${(value / 20) * 100}%"></div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          
          <div class="space-y-6">
            <div class="bg-emerald-50 rounded-xl p-5 border border-emerald-100">
              <h4 class="font-bold text-emerald-700 mb-3">‚úÖ Kekuatan</h4>
              <ul class="space-y-2">
                ${item.strengths.map(s => `<li class="text-sm text-emerald-700 flex items-start gap-2">‚≠ê ${s}</li>`).join('')}
              </ul>
            </div>
            
            <div class="bg-amber-50 rounded-xl p-5 border border-amber-100">
              <h4 class="font-bold text-amber-700 mb-3">üéØ Area Pengembangan</h4>
              <ul class="space-y-2">
                ${item.improvements.map(i => `<li class="text-sm text-amber-700 flex items-start gap-2">üí° ${i}</li>`).join('')}
              </ul>
            </div>
            
            <div class="bg-blue-50 rounded-xl p-5 border border-blue-100">
              <h4 class="font-bold text-blue-700 mb-3">üí¨ Catatan untuk Siswa</h4>
              <p class="text-sm text-blue-700">${item.teacherNote}</p>
            </div>
          </div>
        </div>
        
        ${item.suggestedActivities ? `
        <div class="mt-6 bg-purple-50 rounded-xl p-5 border border-purple-100">
          <h4 class="font-bold text-purple-700 mb-3">‚ö° Aktivitas yang Disarankan</h4>
          <div class="flex flex-wrap gap-2">
            ${item.suggestedActivities.map(a => `<span class="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded-full">${a}</span>`).join('')}
          </div>
        </div>
        ` : ''}
        
        ${(item.cpAchievement || item.tpAchievement) ? `
        <div class="mt-6 bg-indigo-50 rounded-xl p-5 border border-indigo-100">
          <h4 class="font-bold text-indigo-700 mb-3 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
            Pencapaian Pembelajaran
          </h4>
          ${item.cpAchievement ? `
          <div class="mb-3">
            <p class="text-xs font-semibold text-indigo-600 mb-1">Capaian Pembelajaran (CP):</p>
            <p class="text-sm text-indigo-700">${item.cpAchievement}</p>
          </div>
          ` : ''}
          ${item.tpAchievement ? `
          <div>
            <p class="text-xs font-semibold text-indigo-600 mb-1">Tujuan Pembelajaran (TP):</p>
            <p class="text-sm text-indigo-700">${item.tpAchievement}</p>
          </div>
          ` : ''}
        </div>
        ` : ''}
        
        <div class="flex flex-col sm:flex-row gap-3 mt-8">
          ${item.whatsapp ? `
          <button onclick="sendWhatsApp()" class="flex-1 bg-green-500 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-green-600">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
            Kirim WhatsApp
          </button>
          ` : ''}
          <button onclick="startNewAssessment()" class="flex-1 border-2 border-slate-200 text-slate-600 py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-50">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Penilaian Baru
          </button>
        </div>
      `;
    }

    function sendWhatsApp() {
      const item = state.currentAssessment;
      if (!item || !item.whatsapp) return;
      
      const scoreDetails = Object.entries(item.scores)
        .map(([key, val]) => `‚Ä¢ ${key.charAt(0).toUpperCase() + key.slice(1)}: ${val}/20`)
        .join('%0A');
      
      let msg = `*üìù HASIL ASESMEN MENULIS BAHASA INGGRIS*%0A` +
                  `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A%0A` +
                  `üë§ *Siswa:* ${item.student}%0A` +
                  `üè´ *Kelas:* ${item.class}%0A` +
                  `üìö *Genre:* ${item.genre}%0A%0A` +
                  `üéØ *SKOR: ${item.score}/100*%0A` +
                  `üìä *Level: ${item.level}*%0A%0A` +
                  `*Detail Skor:*%0A${scoreDetails}%0A%0A` +
                  `‚úÖ *Kekuatan:*%0A${item.strengths.map(s => `‚Ä¢ ${s}`).join('%0A')}%0A%0A` +
                  `üìà *Pengembangan:*%0A${item.improvements.map(i => `‚Ä¢ ${i}`).join('%0A')}%0A%0A`;
      
      // Add CP/TP achievements if available
      if (item.cpAchievement || item.tpAchievement) {
        msg += `üéì *Pencapaian Pembelajaran:*%0A`;
        if (item.cpAchievement) {
          msg += `‚Ä¢ CP: ${item.cpAchievement}%0A`;
        }
        if (item.tpAchievement) {
          msg += `‚Ä¢ TP: ${item.tpAchievement}%0A`;
        }
        msg += `%0A`;
      }
      
      msg += `üí¨ *Catatan:*%0A${item.teacherNote}%0A%0A` +
                  `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A` +
                  `üè´ ${state.profile.school}%0A` +
                  `üë®‚Äçüè´ ${state.profile.name}`;
      
      window.open(`https://wa.me/${item.whatsapp}?text=${msg}`, '_blank');
    }

    // ==================== ACCORDION ====================
    function toggleAccordion(id) {
      const content = document.getElementById(id);
      const icon = document.getElementById(id + '-icon');
      
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
      } else {
        content.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
      }
    }

    // ==================== HELPERS ====================
    function getScoreColorClass(score) {
      if (score >= 80) return 'text-emerald-600 bg-emerald-50';
      if (score >= 60) return 'text-blue-600 bg-blue-50';
      if (score >= 40) return 'text-amber-600 bg-amber-50';
      return 'text-red-600 bg-red-50';
    }

    function getLevelColorClass(level) {
      const colors = {
        'Exemplary': 'bg-purple-100 text-purple-700 border-purple-200',
        'Advanced': 'bg-emerald-100 text-emerald-700 border-emerald-200',
        'Proficient': 'bg-blue-100 text-blue-700 border-blue-200',
        'Developing': 'bg-amber-100 text-amber-700 border-amber-200',
        'Emerging': 'bg-red-100 text-red-700 border-red-200'
      };
      return colors[level] || 'bg-slate-100 text-slate-700 border-slate-200';
    }
  </script>
</body>
</html>
