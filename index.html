<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WriteRight ‚Äî English Writing Assessment</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800;900&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f3ee; --bg-card: #ffffff; --bg-input: #fafaf7; --bg-dark: #1b2a4a;
  --accent: #2563eb; --accent-light: #3b82f6; --accent-soft: #eff4ff;
  --gold: #b8860b; --gold-soft: #fdf6e3; --gold-border: #e8d5a3;
  --green: #059669; --green-soft: #ecfdf5; --green-border: #a7f3d0;
  --red: #dc2626; --red-soft: #fef2f2; --red-border: #fca5a5;
  --amber: #d97706; --amber-soft: #fffbeb; --amber-border: #fcd34d;
  --text: #1e293b; --text-mid: #475569; --text-muted: #94a3b8;
  --border: #e2e0d8; --border-light: #f0ede6;
  --radius: 14px;
  --shadow: 0 1px 3px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 14px rgba(0,0,0,0.07);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'DM Sans', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* ===== UTILITIES ===== */
.hidden { display: none !important; }

.container { max-width: 720px; margin: 0 auto; padding: 20px 16px; }

.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.25rem;
  box-shadow: var(--shadow);
  margin-bottom: 16px;
}

.card-dark {
  background: var(--bg-dark);
  border: none;
  color: #fff;
}

.card-green {
  background: var(--green-soft);
  border-color: var(--green-border);
}

.card-gold {
  background: var(--gold-soft);
  border-color: var(--gold-border);
}

.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.3px;
}
.badge-blue { background: var(--accent-soft); color: var(--accent); }
.badge-green { background: var(--green-soft); color: var(--green); }
.badge-red { background: var(--red-soft); color: var(--red); }
.badge-amber { background: var(--amber-soft); color: var(--amber); }
.badge-gold { background: var(--gold-soft); color: var(--gold); }

/* ===== BUTTONS ===== */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  border: none; border-radius: 10px; cursor: pointer;
  font-weight: 600; font-family: inherit; font-size: 13.5px;
  padding: 10px 20px; transition: all 0.2s;
  text-decoration: none;
}
.btn:active { transform: scale(0.97); }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-ghost { background: transparent; color: var(--accent); border: 1.5px solid var(--border); }
.btn-ghost:hover { border-color: var(--accent); background: var(--accent-soft); }
.btn-success { background: var(--green); color: #fff; }
.btn-success:hover { background: #047857; }
.btn-gold { background: linear-gradient(135deg, #b8860b, #daa520); color: #fff; box-shadow: 0 2px 10px rgba(184,134,11,0.3); }
.btn-gold:hover { box-shadow: 0 4px 16px rgba(184,134,11,0.4); }
.btn-danger { background: var(--red-soft); color: var(--red); border: 1px solid var(--red-border); }
.btn-sm { padding: 6px 14px; font-size: 12px; }
.btn-lg { padding: 14px 28px; font-size: 15px; }
.btn-full { width: 100%; justify-content: center; }
.btn:disabled { opacity: 0.45; cursor: not-allowed; }

/* ===== FORM ===== */
.form-group { margin-bottom: 14px; }
.form-label {
  display: block; font-size: 12.5px; font-weight: 600;
  color: var(--text-mid); margin-bottom: 5px;
}
.form-label .req { color: var(--red); }
.form-input, .form-textarea {
  width: 100%; padding: 10px 14px;
  border: 1.5px solid var(--border); border-radius: 10px;
  font-size: 14px; font-family: inherit;
  background: var(--bg-input); color: var(--text);
  outline: none; transition: border 0.2s;
}
.form-input:focus, .form-textarea:focus { border-color: var(--accent); }
.form-textarea { resize: vertical; min-height: 76px; }

/* ===== HEADER ===== */
.topbar {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 10px 16px;
  display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; z-index: 50;
}
.topbar-brand { display: flex; align-items: center; gap: 8px; }
.topbar-brand span { font-weight: 800; font-size: 15px; }
.progress-dots { display: flex; gap: 5px; }
.progress-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--border-light); transition: background 0.3s;
}
.progress-dot.active { background: var(--accent); }

/* ===== SCREEN: SETUP ===== */
.setup-hero { text-align: center; margin-bottom: 28px; }
.setup-icon {
  display: inline-flex; align-items: center; justify-content: center;
  width: 56px; height: 56px; border-radius: 16px;
  background: var(--accent-soft); color: var(--accent);
  font-size: 24px; margin-bottom: 12px;
}
.setup-hero h1 {
  font-family: 'DM Serif Display', serif;
  font-size: 28px; font-weight: 400; color: var(--text); margin-bottom: 4px;
}
.setup-hero p { color: var(--text-muted); font-size: 13.5px; }

.section-header {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 16px;
}
.section-header h3 { font-size: 15px; font-weight: 700; }

/* ===== SCREEN: STUDENTS ===== */
.screen-header {
  display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
}
.screen-header h2 { font-size: 20px; font-weight: 800; flex: 1; }
.btn-back {
  background: none; border: none; cursor: pointer;
  color: var(--text-muted); font-size: 20px; padding: 4px;
  display: flex; align-items: center;
}
.btn-back:hover { color: var(--accent); }

.student-row {
  display: grid;
  grid-template-columns: 32px 1fr 1fr 36px;
  gap: 8px; align-items: center;
  padding: 8px 0;
}
.student-row + .student-row { border-top: 1px solid var(--border-light); }
.student-num {
  width: 28px; height: 28px; border-radius: 8px;
  background: var(--accent-soft); display: flex;
  align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; color: var(--accent);
}
.student-row input {
  padding: 8px 12px; border: 1.5px solid var(--border);
  border-radius: 8px; font-size: 13.5px; font-family: inherit;
  background: var(--bg-input); color: var(--text); outline: none; width: 100%;
}
.student-row input:focus { border-color: var(--accent); }
.btn-remove {
  background: none; border: none; cursor: pointer;
  color: var(--text-muted); font-size: 16px; padding: 4px;
}
.btn-remove:hover { color: var(--red); }
.btn-remove:disabled { color: var(--border-light); cursor: default; }

/* ===== SCREEN: SELECT ===== */
.student-card {
  cursor: pointer; transition: all 0.2s;
  border: 1.5px solid var(--border);
}
.student-card:hover { border-color: var(--accent); box-shadow: var(--shadow-md); }
.student-card.done { border-color: var(--green-border); background: var(--green-soft); }
.student-card-inner {
  display: flex; justify-content: space-between; align-items: center;
}
.student-card-left { display: flex; align-items: center; gap: 12px; }
.student-card-avatar {
  width: 42px; height: 42px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 14px;
}
.student-card-name { font-weight: 700; font-size: 14px; }
.student-card-wa { font-size: 12px; color: var(--text-muted); }
.student-card-actions {
  margin-top: 10px; padding-top: 10px;
  border-top: 1px solid var(--green-border);
  display: flex; gap: 8px;
}

/* ===== SCREEN: SCAN ===== */
.scan-upload {
  text-align: center; padding: 2rem 1rem;
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  background: var(--bg-input);
  cursor: pointer;
  transition: all 0.2s;
}
.scan-upload:hover { border-color: var(--accent); background: var(--accent-soft); }
.scan-upload-icon { font-size: 42px; margin-bottom: 8px; }
.scan-upload h4 { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
.scan-upload p { font-size: 12.5px; color: var(--text-muted); }
.scan-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 16px; }

.pages-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
  gap: 10px; margin-top: 12px;
}
.page-thumb {
  position: relative; border-radius: 10px; overflow: hidden;
  border: 1.5px solid var(--border); aspect-ratio: 3/4;
  background: #f0f0f0;
}
.page-thumb img { width: 100%; height: 100%; object-fit: cover; }
.page-thumb-header {
  position: absolute; top: 0; left: 0; right: 0;
  padding: 4px 8px; background: rgba(0,0,0,0.6);
  display: flex; justify-content: space-between; align-items: center;
}
.page-thumb-header span { color: #fff; font-size: 11px; font-weight: 600; }
.page-thumb-remove {
  background: rgba(255,255,255,0.2); border: none; border-radius: 4px;
  padding: 2px 5px; cursor: pointer; color: #fff; font-size: 12px; line-height: 1;
}

.processing-card { text-align: center; padding: 2rem; }
.processing-spinner {
  display: inline-block; font-size: 36px;
  animation: spin 1.5s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.processing-card h4 { font-weight: 700; margin: 8px 0 4px; }
.processing-card p { font-size: 12.5px; color: var(--text-muted); line-height: 1.6; }
.processing-steps { text-align: left; margin-top: 16px; }
.processing-step {
  display: flex; gap: 10px; align-items: center;
  padding: 6px 0; font-size: 13px; color: var(--text-muted);
}
.processing-step.done { color: var(--green); }
.processing-step.active { color: var(--accent); font-weight: 600; }

/* ===== SCREEN: RESULT ===== */
.result-header {
  display: flex; justify-content: space-between;
  align-items: center; flex-wrap: wrap; gap: 12px;
}
.result-header-info h3 { font-size: 18px; font-weight: 800; color: #fff; }
.result-header-info p { font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 2px; }
.result-header-info small { font-size: 11px; color: rgba(255,255,255,0.4); }

.score-ring { position: relative; display: inline-block; }
.score-ring-value {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  font-weight: 900; font-size: 28px;
}

.score-bar-item { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.score-bar-icon { font-size: 18px; flex-shrink: 0; }
.score-bar-content { flex: 1; }
.score-bar-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
.score-bar-label { font-size: 13px; font-weight: 600; }
.score-bar-value { font-size: 13px; font-weight: 700; }
.score-bar-track { height: 8px; background: var(--border-light); border-radius: 4px; overflow: hidden; }
.score-bar-fill { height: 100%; border-radius: 4px; transition: width 1.2s ease; }

.correction-item {
  padding: 14px; border-radius: 10px;
  background: var(--bg-input); border: 1px solid var(--border-light);
  margin-bottom: 10px;
}
.correction-compare {
  display: grid; grid-template-columns: 1fr auto 1fr;
  gap: 8px; align-items: center; margin: 10px 0;
}
.correction-old {
  padding: 8px 12px; border-radius: 8px;
  background: var(--red-soft); border: 1px solid var(--red-border);
  font-size: 13px; color: var(--red); text-decoration: line-through; line-height: 1.5;
}
.correction-new {
  padding: 8px 12px; border-radius: 8px;
  background: var(--green-soft); border: 1px solid var(--green-border);
  font-size: 13px; color: var(--green); font-weight: 600; line-height: 1.5;
}
.correction-arrow { font-size: 18px; color: var(--text-muted); text-align: center; }
.correction-explain { font-size: 12.5px; color: var(--text-mid); font-style: italic; line-height: 1.5; }

.rec-block {
  padding: 14px; border-radius: 10px;
  background: rgba(255,255,255,0.7); border: 1px solid var(--gold-border);
  margin-bottom: 12px;
}
.rec-block h4 { font-size: 14px; font-weight: 700; margin-bottom: 8px; }
.rec-block .rec-sub { font-size: 12px; font-weight: 600; color: var(--text-mid); margin-bottom: 4px; }
.rec-tip { font-size: 13px; color: var(--text-mid); line-height: 1.6; margin-bottom: 2px; display: flex; gap: 6px; }
.rec-resource { font-size: 12.5px; color: var(--accent); line-height: 1.5; margin-bottom: 1px; display: flex; gap: 6px; }

.feedback-text { font-size: 14px; color: var(--text); line-height: 1.7; }
.strength-item { font-size: 13px; color: var(--text-mid); line-height: 1.6; display: flex; gap: 6px; margin-bottom: 2px; }

.cp-ref { font-size: 12.5px; color: var(--text-mid); line-height: 1.6; }
.cp-ref strong { color: var(--text); font-size: 13px; }

.result-actions { display: flex; gap: 10px; flex-wrap: wrap; margin: 20px 0 32px; }

/* ===== RESPONSIVE ===== */
@media (max-width: 480px) {
  .student-row { grid-template-columns: 28px 1fr 36px; }
  .student-row input:nth-child(3) { grid-column: 2; }
  .correction-compare { grid-template-columns: 1fr; }
  .correction-arrow { transform: rotate(90deg); }
  .scan-buttons { flex-direction: column; }
  .scan-buttons .btn { width: 100%; justify-content: center; }
}
</style>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar hidden" id="topbar">
  <div class="topbar-brand">
    <span>‚úçÔ∏è</span>
    <span>WriteRight</span>
    <span class="badge badge-blue" id="topbar-school"></span>
  </div>
  <div class="progress-dots" id="progress-dots"></div>
</div>

<!-- ===== SCREENS ===== -->

<!-- SCREEN: SETUP -->
<div id="screen-setup" class="container">
  <div class="setup-hero">
    <div class="setup-icon">üìã</div>
    <h1>WriteRight</h1>
    <p>English Writing Assessment for Teachers</p>
  </div>

  <div class="card">
    <div class="section-header">
      <span style="color:var(--accent)">üè´</span>
      <h3>Informasi Sekolah & Pembelajaran</h3>
    </div>

    <div class="form-group">
      <label class="form-label">Nama Sekolah <span class="req">*</span></label>
      <input class="form-input" id="inp-school" placeholder="SMK Negeri 1 Maluku Tengah">
    </div>
    <div class="form-group">
      <label class="form-label">Kelas <span class="req">*</span></label>
      <input class="form-input" id="inp-kelas" placeholder="X TJKT">
    </div>
    <div class="form-group">
      <label class="form-label">Capaian Pembelajaran (CP) <span class="req">*</span></label>
      <textarea class="form-textarea" id="inp-cp" rows="3" placeholder="Menulis-Mempresentasikan (Writing - Presenting) Mengomunikasikan gagasan dan pengalaman mereka secara tertulis atau multimodal dalam berbagai jenis teks fiksi dan nonfiksi ......."></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Tujuan Pembelajaran (TP) <span class="req">*</span></label>
      <textarea class="form-textarea" id="inp-tp" rows="3" placeholder="Menyusun kerangka teks perkenalan diri yang mencakup identitas (opening), latar belakang keluarga/pendidikan (content), serta harapan atau hobi (closing) secara sistematis....."></textarea>
    </div>

    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button class="btn btn-primary" id="btn-to-students" disabled>üë• Lanjut: Data Siswa ‚Üí</button>
    </div>
  </div>
</div>

<!-- SCREEN: STUDENTS -->
<div id="screen-students" class="container hidden">
  <div class="screen-header">
    <button class="btn-back" id="btn-back-setup">‚Üê</button>
    <h2>Data Siswa</h2>
    <span class="badge badge-blue" id="label-kelas-students"></span>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="color:var(--accent)">üë•</span>
        <span style="font-weight:700;font-size:14px">Daftar Siswa (<span id="student-count">1</span>)</span>
      </div>
      <button class="btn btn-ghost btn-sm" id="btn-add-student">Ôºã Tambah</button>
    </div>

    <div id="student-list"></div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px">
      <span style="font-size:12px;color:var(--text-muted)">üí° No WA untuk kirim hasil via WhatsApp</span>
      <button class="btn btn-primary" id="btn-to-select">üì∑ Lanjut: Pilih Siswa ‚Üí</button>
    </div>
  </div>
</div>

<!-- SCREEN: SELECT STUDENT -->
<div id="screen-select" class="container hidden">
  <div class="screen-header">
    <button class="btn-back" id="btn-back-students">‚Üê</button>
    <h2>Pilih Siswa untuk Dinilai</h2>
  </div>
  <div id="select-list"></div>
</div>

<!-- SCREEN: SCAN -->
<div id="screen-scan" class="container hidden">
  <div class="screen-header">
    <button class="btn-back" id="btn-back-select">‚Üê</button>
    <h2>Scan Tulisan</h2>
    <span class="badge badge-blue" id="label-scan-student"></span>
  </div>

  <div class="card" id="scan-upload-area">
    <div class="scan-upload" id="scan-dropzone">
      <div class="scan-upload-icon">üì∏</div>
      <h4>Scan / Upload Tulisan Siswa</h4>
      <p>Bisa lebih dari 1 halaman ‚Äî foto atau upload gambar</p>
    </div>
    <div class="scan-buttons">
      <button class="btn btn-primary btn-lg" id="btn-camera">üì∑ Ambil Foto</button>
      <button class="btn btn-ghost btn-lg" id="btn-upload">üìÅ Upload File</button>
    </div>
    <input type="file" accept="image/*" capture="environment" id="inp-camera" style="display:none">
    <input type="file" accept="image/*,.pdf" multiple id="inp-upload" style="display:none">
  </div>

  <div class="card hidden" id="pages-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="font-weight:700;font-size:14px">üìÑ Halaman Terscan (<span id="page-count">0</span>)</span>
      <button class="btn btn-ghost btn-sm" id="btn-add-page">Ôºã Tambah</button>
    </div>
    <div class="pages-grid" id="pages-grid"></div>
  </div>

  <button class="btn btn-gold btn-lg btn-full hidden" id="btn-process" style="margin-top:8px">
    ‚ú® Proses dengan AI
  </button>

  <div class="card hidden" id="processing-card">
    <div class="processing-card">
      <div class="processing-spinner">üîÑ</div>
      <h4>Sedang Menganalisis...</h4>
      <p id="processing-name"></p>
      <div class="processing-steps" id="processing-steps"></div>
    </div>
  </div>
</div>

<!-- SCREEN: RESULT -->
<div id="screen-result" class="container hidden"></div>

<!-- ===== JAVASCRIPT ===== -->
<script>
// ============ STATE ============
const state = {
  school: { name: "", kelas: "", cp: "", tp: "" },
  students: [{ id: 1, name: "", wa: "" }],
  selectedStudent: null,
  scannedPages: [],
  results: {},
  nextId: 2,
};

const screens = ["setup", "students", "select", "scan", "result"];
let currentScreen = "setup";

// ============ NAVIGATION ============
function showScreen(name) {
  currentScreen = name;
  screens.forEach(s => {
    document.getElementById(`screen-${s}`).classList.toggle("hidden", s !== name);
  });

  const topbar = document.getElementById("topbar");
  topbar.classList.toggle("hidden", name === "setup");
  document.getElementById("topbar-school").textContent = state.school.name;

  const dots = document.getElementById("progress-dots");
  dots.innerHTML = screens.map((s, i) => {
    const active = screens.indexOf(name) >= i;
    return `<div class="progress-dot ${active ? "active" : ""}"></div>`;
  }).join("");

  window.scrollTo(0, 0);
}

// ============ SETUP SCREEN ============
const inpSchool = document.getElementById("inp-school");
const inpKelas = document.getElementById("inp-kelas");
const inpCp = document.getElementById("inp-cp");
const inpTp = document.getElementById("inp-tp");
const btnToStudents = document.getElementById("btn-to-students");

function validateSetup() {
  const valid = inpSchool.value.trim() && inpKelas.value.trim() && inpCp.value.trim() && inpTp.value.trim();
  btnToStudents.disabled = !valid;
}
[inpSchool, inpKelas, inpCp, inpTp].forEach(el => el.addEventListener("input", validateSetup));

btnToStudents.addEventListener("click", () => {
  state.school = {
    name: inpSchool.value.trim(),
    kelas: inpKelas.value.trim(),
    cp: inpCp.value.trim(),
    tp: inpTp.value.trim(),
  };
  document.getElementById("label-kelas-students").textContent = state.school.kelas;
  renderStudents();
  showScreen("students");
});

// ============ STUDENTS SCREEN ============
function renderStudents() {
  const list = document.getElementById("student-list");
  document.getElementById("student-count").textContent = state.students.length;

  list.innerHTML = state.students.map((s, i) => `
    <div class="student-row" data-id="${s.id}">
      <div class="student-num">${i + 1}</div>
      <input type="text" value="${esc(s.name)}" placeholder="Nama Lengkap Siswa" data-field="name" class="student-input">
      <input type="tel" value="${esc(s.wa)}" placeholder="No. WA (08xxx)" data-field="wa" class="student-input">
      <button class="btn-remove" data-id="${s.id}" ${state.students.length <= 1 ? "disabled" : ""}>üóë</button>
    </div>
  `).join("");

  list.querySelectorAll(".student-input").forEach(inp => {
    inp.addEventListener("input", (e) => {
      const row = e.target.closest(".student-row");
      const id = parseInt(row.dataset.id);
      const field = e.target.dataset.field;
      const st = state.students.find(s => s.id === id);
      if (st) st[field] = e.target.value;
      updateSelectBtn();
    });
  });

  list.querySelectorAll(".btn-remove").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const id = parseInt(e.currentTarget.dataset.id);
      state.students = state.students.filter(s => s.id !== id);
      renderStudents();
    });
  });

  updateSelectBtn();
}

function updateSelectBtn() {
  document.getElementById("btn-to-select").disabled = state.students.every(s => !s.name.trim());
}

document.getElementById("btn-add-student").addEventListener("click", () => {
  state.students.push({ id: state.nextId++, name: "", wa: "" });
  renderStudents();
});

document.getElementById("btn-back-setup").addEventListener("click", () => showScreen("setup"));

document.getElementById("btn-to-select").addEventListener("click", () => {
  renderSelectList();
  showScreen("select");
});

// ============ SELECT SCREEN ============
function renderSelectList() {
  const list = document.getElementById("select-list");
  const validStudents = state.students.filter(s => s.name.trim());

  list.innerHTML = validStudents.map((s, i) => {
    const res = state.results[s.id];
    const done = !!res;

    return `
      <div class="card student-card ${done ? "done" : ""}" data-sid="${s.id}" style="margin-bottom:10px">
        <div class="student-card-inner" data-action="scan">
          <div class="student-card-left">
            <div class="student-card-avatar" style="background:${done ? "var(--green-soft)" : "var(--accent-soft)"};border:1.5px solid ${done ? "var(--green-border)" : "var(--border)"};color:${done ? "var(--green)" : "var(--accent)"}">
              ${i + 1}
            </div>
            <div>
              <div class="student-card-name">${esc(s.name)}</div>
              <div class="student-card-wa">${s.wa ? esc(s.wa) : "No WA belum diisi"}</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            ${done ? `<span class="badge badge-green">‚úì Skor: ${res.overall}</span>` : ""}
            <span style="color:var(--accent);font-size:13px;font-weight:600">Scan ‚Üí</span>
          </div>
        </div>
        ${done ? `
          <div class="student-card-actions">
            <button class="btn btn-ghost btn-sm" data-action="view" data-sid="${s.id}">üìä Lihat Hasil</button>
            ${s.wa ? `<button class="btn btn-success btn-sm" data-action="wa" data-sid="${s.id}">üì§ Kirim WA</button>` : ""}
          </div>
        ` : ""}
      </div>
    `;
  }).join("");

  list.querySelectorAll("[data-action='scan']").forEach(el => {
    el.addEventListener("click", (e) => {
      const sid = parseInt(e.currentTarget.closest(".student-card").dataset.sid);
      state.selectedStudent = state.students.find(s => s.id === sid);
      state.scannedPages = [];
      startScan();
    });
  });

  list.querySelectorAll("[data-action='view']").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const sid = parseInt(btn.dataset.sid);
      state.selectedStudent = state.students.find(s => s.id === sid);
      renderResult(state.results[sid]);
      showScreen("result");
    });
  });

  list.querySelectorAll("[data-action='wa']").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const sid = parseInt(btn.dataset.sid);
      const student = state.students.find(s => s.id === sid);
      shareWA(student, state.results[sid]);
    });
  });
}

document.getElementById("btn-back-students").addEventListener("click", () => showScreen("students"));

// ============ SCAN SCREEN ============
function startScan() {
  document.getElementById("label-scan-student").textContent = state.selectedStudent.name;
  document.getElementById("pages-grid").innerHTML = "";
  document.getElementById("pages-card").classList.add("hidden");
  document.getElementById("btn-process").classList.add("hidden");
  document.getElementById("processing-card").classList.add("hidden");
  document.getElementById("scan-upload-area").classList.remove("hidden");
  state.scannedPages = [];
  showScreen("scan");
}

document.getElementById("btn-back-select").addEventListener("click", () => {
  renderSelectList();
  showScreen("select");
});

document.getElementById("btn-camera").addEventListener("click", () => document.getElementById("inp-camera").click());
document.getElementById("btn-upload").addEventListener("click", () => document.getElementById("inp-upload").click());
document.getElementById("btn-add-page").addEventListener("click", () => document.getElementById("inp-upload").click());

document.getElementById("inp-camera").addEventListener("change", handleFiles);
document.getElementById("inp-upload").addEventListener("change", handleFiles);

function handleFiles(e) {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      state.scannedPages.push({ id: Date.now() + Math.random(), src: ev.target.result, name: file.name });
      renderPages();
    };
    reader.readAsDataURL(file);
  });
  e.target.value = "";
}

function renderPages() {
  const grid = document.getElementById("pages-grid");
  const pagesCard = document.getElementById("pages-card");
  const btnProcess = document.getElementById("btn-process");
  const count = state.scannedPages.length;

  document.getElementById("page-count").textContent = count;

  if (count > 0) {
    pagesCard.classList.remove("hidden");
    btnProcess.classList.remove("hidden");
    btnProcess.innerHTML = `‚ú® Proses dengan AI (${count} halaman)`;
  } else {
    pagesCard.classList.add("hidden");
    btnProcess.classList.add("hidden");
  }

  grid.innerHTML = state.scannedPages.map((p, i) => `
    <div class="page-thumb" data-pid="${p.id}">
      <img src="${p.src}" alt="Halaman ${i + 1}">
      <div class="page-thumb-header">
        <span>Hal ${i + 1}</span>
        <button class="page-thumb-remove" data-pid="${p.id}">‚úï</button>
      </div>
    </div>
  `).join("");

  grid.querySelectorAll(".page-thumb-remove").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const pid = parseFloat(btn.dataset.pid);
      state.scannedPages = state.scannedPages.filter(p => p.id !== pid);
      renderPages();
    });
  });
}

// ============ AI PROCESSING ============
document.getElementById("btn-process").addEventListener("click", processWithAI);

async function processWithAI() {
  const btnProcess = document.getElementById("btn-process");
  const processingCard = document.getElementById("processing-card");
  const uploadArea = document.getElementById("scan-upload-area");

  btnProcess.classList.add("hidden");
  processingCard.classList.remove("hidden");
  document.getElementById("processing-name").innerHTML =
    `AI sedang membaca dan menilai tulisan <strong>${esc(state.selectedStudent.name)}</strong>`;

  const steps = [
    { text: "Membaca gambar tulisan (OCR)...", delay: 800 },
    { text: "Menganalisis grammar & structure...", delay: 700 },
    { text: "Mengevaluasi vocabulary range...", delay: 600 },
    { text: "Menilai coherence & cohesion...", delay: 600 },
    { text: "Memeriksa task achievement...", delay: 500 },
    { text: "Menyusun feedback & rekomendasi...", delay: 800 },
  ];

  const stepsEl = document.getElementById("processing-steps");
  stepsEl.innerHTML = steps.map((s, i) => `
    <div class="processing-step" id="pstep-${i}">
      <span>‚è≥</span> <span>${s.text}</span>
    </div>
  `).join("");

  for (let i = 0; i < steps.length; i++) {
    const el = document.getElementById(`pstep-${i}`);
    el.classList.add("active");
    el.querySelector("span").textContent = "‚è≥";
    await sleep(steps[i].delay);
    el.classList.remove("active");
    el.classList.add("done");
    el.querySelector("span").textContent = "‚úÖ";
  }

  await sleep(400);

  // Generate result
  const result = generateAIResult();
  state.results[state.selectedStudent.id] = result;
  renderResult(result);
  showScreen("result");
}

function generateAIResult() {
  const name = state.selectedStudent.name;

  const allCorrections = [
    { original: "I think education is very important for our life", corrected: "I believe education is crucial for our lives", type: "vocabulary", explanation: "Gunakan kata yang lebih kuat: 'believe' lebih tegas dari 'think', 'crucial' lebih kuat dari 'very important', dan 'lives' (plural) lebih tepat." },
    { original: "Many student dont know about this", corrected: "Many students don't know about this", type: "grammar", explanation: "Plural noun perlu 's' (student ‚Üí students) dan gunakan apostrophe pada kontraksi (dont ‚Üí don't)." },
    { original: "We must to study hard every day", corrected: "We must study hard every day", type: "grammar", explanation: "Setelah modal verb 'must', langsung gunakan bare infinitive tanpa 'to'." },
    { original: "In the other hand, some people disagree", corrected: "On the other hand, some people disagree", type: "expression", explanation: "Frasa yang benar adalah 'On the other hand' ‚Äî ini adalah fixed expression dalam bahasa Inggris." },
    { original: "I very like reading books in the morning", corrected: "I really enjoy reading books in the morning", type: "word_order", explanation: "Adverb 'very' tidak bisa diletakkan sebelum verb. Gunakan 'really enjoy' yang lebih natural dan tepat." },
    { original: "This make me feel happy and excited", corrected: "This makes me feel happy and excited", type: "grammar", explanation: "'This' adalah singular subject, sehingga verb harus ditambah '-s' menjadi 'makes' (Subject-Verb Agreement)." },
    { original: "The technology has change our life drasticly", corrected: "Technology has changed our lives drastically", type: "grammar", explanation: "Present perfect membutuhkan past participle 'changed'. 'Drastically' adalah ejaan yang benar. 'Technology' tanpa 'The' untuk konsep umum." },
    { original: "Beside that, we need more practice", corrected: "Besides that, we need more practice", type: "expression", explanation: "'Besides' (dengan 's') berarti 'selain itu', sedangkan 'Beside' (tanpa 's') berarti 'di samping' (lokasi fisik)." },
  ];

  const shuffled = allCorrections.sort(() => Math.random() - 0.5);
  const corrections = shuffled.slice(0, 4 + Math.floor(Math.random() * 3));

  const scores = {
    grammar: rand(52, 88),
    vocabulary: rand(50, 85),
    coherence: rand(55, 90),
    task: rand(58, 92),
    mechanics: rand(60, 90),
  };

  const overall = Math.round(Object.values(scores).reduce((a, b) => a + b, 0) / 5);

  const strengthsPool = [
    "Ide utama tersampaikan dengan cukup jelas kepada pembaca",
    "Penggunaan paragraf sudah terstruktur: ada pembuka, isi, dan penutup",
    "Ada usaha yang baik menggunakan connecting words (however, moreover, furthermore)",
    "Topik dijawab dengan relevan sesuai instruksi yang diberikan",
    "Kalimat pembuka (thesis statement) sudah cukup kuat",
    "Terdapat variasi dalam panjang kalimat yang menunjukkan perkembangan writing skill",
  ];
  const strengths = strengthsPool.sort(() => Math.random() - 0.5).slice(0, 3);

  let feedbackPositive;
  if (overall >= 80) {
    feedbackPositive = `Excellent work, ${name}! üåü Tulisanmu menunjukkan pemahaman yang sangat baik. Struktur essay-mu sudah kuat, vocabulary cukup beragam, dan ide tersampaikan dengan jelas. Terus kembangkan kemampuanmu ‚Äî kamu sudah di jalur yang luar biasa!`;
  } else if (overall >= 65) {
    feedbackPositive = `Good effort, ${name}! üëè Tulisanmu menunjukkan kemajuan yang nyata. Kamu sudah bisa menyusun paragraf dengan baik dan ide utamamu jelas. Ada beberapa area yang bisa ditingkatkan, tapi secara keseluruhan ini adalah pekerjaan yang bagus. Keep improving!`;
  } else if (overall >= 50) {
    feedbackPositive = `Nice try, ${name}! üí™ Kamu sudah berani menuangkan ide ke dalam tulisan ‚Äî itu langkah yang penting! Ada beberapa hal yang perlu diperbaiki, tapi jangan khawatir, setiap penulis hebat juga pernah di tahap ini. Mari kita tingkatkan bersama, satu langkah pada satu waktu!`;
  } else {
    feedbackPositive = `Keep going, ${name}! üå± Setiap tulisan adalah latihan yang berharga. Yang paling penting adalah kamu sudah mencoba ‚Äî banyak orang tidak berani memulai. Perhatikan rekomendasi belajar di bawah ini, praktikkan sedikit demi sedikit, dan kamu pasti akan melihat kemajuan!`;
  }

  const recommendations = [];

  if (scores.grammar < 75) {
    recommendations.push({
      area: "Grammar & Structure", icon: "üìò",
      tips: [
        "Pelajari Subject-Verb Agreement ‚Äî pastikan subject dan verb selalu cocok (he goes, they go)",
        "Latih 3 tenses utama: Simple Present, Simple Past, dan Present Perfect",
        "Perhatikan penggunaan articles (a, an, the) ‚Äî ini sering jadi kelemahan penulis ESL",
        "Buat 5 kalimat setiap hari menggunakan grammar rule yang berbeda",
      ],
      resources: [
        "üìï English Grammar in Use (Raymond Murphy) ‚Äî Unit 1-25",
        "üåê Grammarly.com ‚Äî pasang extension browser untuk latihan mandiri",
        "üé¨ YouTube: English Addict with Mr. Steve ‚Äî Grammar Series",
        "üì± App: Duolingo English ‚Äî fokus pada Grammar Skills",
      ]
    });
  }

  if (scores.vocabulary < 75) {
    recommendations.push({
      area: "Vocabulary Range", icon: "üìó",
      tips: [
        "Buat vocabulary journal ‚Äî catat 5 kata baru setiap hari beserta contoh kalimatnya",
        "Ganti kata-kata sederhana: very good ‚Üí excellent, very bad ‚Üí terrible, very big ‚Üí enormous",
        "Baca 1 artikel bahasa Inggris sehari dari News in Levels (level 2 atau 3)",
        "Gunakan thesaurus (sinonim) saat menulis untuk variasi kata",
      ],
      resources: [
        "üìï Wordly Wise 3000 Level 9-12",
        "üåê Quizlet.com ‚Äî cari 'Academic Word List' flashcards",
        "üåê newsinlevels.com ‚Äî berita sesuai level bahasa Inggris",
        "üì± App: Vocabulary.com ‚Äî belajar kata dengan konteks",
      ]
    });
  }

  if (scores.coherence < 75) {
    recommendations.push({
      area: "Coherence & Organization", icon: "üìô",
      tips: [
        "Selalu buat outline sebelum menulis: Introduction ‚Üí Body 1 ‚Üí Body 2 ‚Üí Conclusion",
        "Setiap paragraf harus punya 1 main idea + 2-3 supporting sentences",
        "Gunakan transition words: Furthermore, However, In addition, On the other hand, As a result",
        "Kalimat terakhir setiap paragraf harus menghubungkan ke paragraf berikutnya",
      ],
      resources: [
        "üìï Writing Academic English (Oshima & Hogue) ‚Äî Chapter 3-6",
        "üåê Purdue OWL ‚Äî Paragraph Structure & Transitions",
        "üé¨ YouTube: Write & Improve with Cambridge ‚Äî Essay Structure",
        "üì± App: Hemingway Editor ‚Äî cek keterbacaan tulisan",
      ]
    });
  }

  if (scores.task < 75) {
    recommendations.push({
      area: "Task Achievement", icon: "üìï",
      tips: [
        "Baca instruksi/prompt 2-3 kali ‚Äî garis bawahi kata kunci (discuss, compare, argue)",
        "Pastikan SEMUA bagian prompt dijawab dalam tulisanmu",
        "Tulis minimal 3 paragraf terstruktur, idealnya 4-5 paragraf",
        "Di conclusion, rangkum main points dan berikan final thought",
      ],
      resources: [
        "üåê WriteAndImprove.com ‚Äî latihan writing gratis dari Cambridge",
        "üåê IELTS Liz ‚Äî contoh essay & cara menjawab berbagai task type",
        "üìï Collins Writing for IELTS ‚Äî panduan menulis berbagai jenis teks",
        "üì± App: Essay Punch ‚Äî latihan menulis essay step-by-step",
      ]
    });
  }

  if (scores.mechanics < 75) {
    recommendations.push({
      area: "Mechanics (Spelling & Punctuation)", icon: "üìì",
      tips: [
        "Selalu proofread tulisan sebelum dikumpulkan ‚Äî baca dari bawah ke atas untuk cek spelling",
        "Perhatikan penggunaan capital letters: awal kalimat, nama, hari, bulan",
        "Gunakan koma sebelum conjunction (and, but, or) dalam compound sentences",
        "Pelajari perbedaan common misspellings: their/there/they're, its/it's, your/you're",
      ],
      resources: [
        "üåê LanguageTool.org ‚Äî grammar & spelling checker gratis",
        "üìï The Elements of Style (Strunk & White) ‚Äî panduan penulisan klasik",
        "üé¨ YouTube: Oxford Online English ‚Äî Punctuation Series",
        "üì± App: Ginger Grammar ‚Äî spell check & corrections",
      ]
    });
  }

  if (recommendations.length === 0) {
    recommendations.push({
      area: "Advanced Writing Skills", icon: "üåü",
      tips: [
        "Coba gunakan complex sentences dengan relative clauses (who, which, that)",
        "Eksplorasi rhetorical devices: metaphor, simile, rhetorical questions",
        "Latih menulis argumentative essay dengan counter-argument dan rebuttal",
        "Baca essay dari penulis terkenal untuk mempelajari style dan tone",
      ],
      resources: [
        "üé¨ TED Talks ‚Äî tonton & tulis summary (latih comprehension + writing)",
        "üìï They Say / I Say (Graff & Birkenstein) ‚Äî academic argumentation",
        "üåê The Atlantic / The Guardian ‚Äî baca artikel opini berkualitas",
        "üì± App: Medium ‚Äî baca & tulis artikel berbagai topik",
      ]
    });
  }

  return {
    student: { ...state.selectedStudent },
    scores, overall, corrections, strengths,
    feedbackPositive, recommendations,
    timestamp: new Date().toLocaleString("id-ID"),
    pageCount: state.scannedPages.length,
  };
}

// ============ RESULT SCREEN ============
function renderResult(r) {
  const el = document.getElementById("screen-result");
  const scoreColor = (v) => v >= 80 ? "var(--green)" : v >= 60 ? "var(--amber)" : "var(--red)";

  const scoreDims = [
    { key: "grammar", label: "Grammar & Structure", icon: "üìò" },
    { key: "vocabulary", label: "Vocabulary Range", icon: "üìó" },
    { key: "coherence", label: "Coherence & Cohesion", icon: "üìô" },
    { key: "task", label: "Task Achievement", icon: "üìï" },
    { key: "mechanics", label: "Mechanics (Spelling, Punctuation)", icon: "üìì" },
  ];

  const typeLabel = (t) => ({
    grammar: "Grammar", vocabulary: "Vocabulary",
    expression: "Expression", word_order: "Word Order",
  }[t] || t);

  const typeColor = (t) => ({
    grammar: "red", vocabulary: "amber",
    expression: "blue", word_order: "blue",
  }[t] || "blue");

  // Build SVG ring
  const ringSize = 90;
  const rr = (ringSize - 10) / 2;
  const circ = 2 * Math.PI * rr;
  const offset = circ * (1 - r.overall / 100);
  const ringColor = scoreColor(r.overall);

  el.innerHTML = `
    <div class="screen-header">
      <button class="btn-back" id="btn-back-result">‚Üê</button>
      <h2>Hasil Asesmen</h2>
    </div>

    <!-- Student Header -->
    <div class="card card-dark" style="margin-bottom:16px">
      <div class="result-header">
        <div class="result-header-info">
          <h3>${esc(r.student.name)}</h3>
          <p>${esc(state.school.name)} ‚Äî ${esc(state.school.kelas)}</p>
          <small>${r.timestamp} ‚Ä¢ ${r.pageCount} halaman</small>
        </div>
        <div class="score-ring">
          <svg width="${ringSize}" height="${ringSize}" style="transform:rotate(-90deg)">
            <circle cx="${ringSize / 2}" cy="${ringSize / 2}" r="${rr}" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="7"/>
            <circle cx="${ringSize / 2}" cy="${ringSize / 2}" r="${rr}" fill="none" stroke="${ringColor}" stroke-width="7"
              stroke-dasharray="${circ}" stroke-dashoffset="${offset}" stroke-linecap="round"
              style="transition:stroke-dashoffset 1.5s ease"/>
          </svg>
          <div class="score-ring-value" style="color:${ringColor}">${r.overall}</div>
        </div>
      </div>
    </div>

    <!-- Score Breakdown -->
    <div class="card" style="margin-bottom:16px">
      <h3 style="font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px">
        üìä Skor Detail
      </h3>
      ${scoreDims.map(d => {
        const v = r.scores[d.key];
        const c = scoreColor(v);
        return `
          <div class="score-bar-item">
            <span class="score-bar-icon">${d.icon}</span>
            <div class="score-bar-content">
              <div class="score-bar-top">
                <span class="score-bar-label">${d.label}</span>
                <span class="score-bar-value" style="color:${c}">${v}/100</span>
              </div>
              <div class="score-bar-track">
                <div class="score-bar-fill" style="width:${v}%;background:${c}"></div>
              </div>
            </div>
          </div>
        `;
      }).join("")}
    </div>

    <!-- Positive Feedback -->
    <div class="card card-green" style="margin-bottom:16px">
      <h3 style="font-size:15px;font-weight:700;color:var(--green);margin-bottom:10px;display:flex;align-items:center;gap:8px">
        üí¨ Feedback Positif
      </h3>
      <p class="feedback-text">${esc(r.feedbackPositive)}</p>
      <div style="margin-top:12px">
        <div style="font-size:12.5px;font-weight:600;color:var(--green);margin-bottom:6px">‚úÖ Kekuatan:</div>
        ${r.strengths.map(s => `<div class="strength-item"><span style="color:var(--green)">‚Ä¢</span> ${esc(s)}</div>`).join("")}
      </div>
    </div>

    <!-- Corrections -->
    <div class="card" style="margin-bottom:16px">
      <h3 style="font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px">
        ‚úèÔ∏è Koreksi & Perbaikan (${r.corrections.length} item)
      </h3>
      ${r.corrections.map(c => `
        <div class="correction-item">
          <span class="badge badge-${typeColor(c.type)}">${typeLabel(c.type)}</span>
          <div class="correction-compare">
            <div class="correction-old">${esc(c.original)}</div>
            <div class="correction-arrow">‚Üí</div>
            <div class="correction-new">${esc(c.corrected)}</div>
          </div>
          <div class="correction-explain">üí° ${esc(c.explanation)}</div>
        </div>
      `).join("")}
    </div>

    <!-- Recommendations -->
    <div class="card card-gold" style="margin-bottom:16px">
      <h3 style="font-size:15px;font-weight:700;color:var(--gold);margin-bottom:14px;display:flex;align-items:center;gap:8px">
        üìñ Rekomendasi Belajar
      </h3>
      ${r.recommendations.map(rec => `
        <div class="rec-block">
          <h4>${rec.icon} ${rec.area}</h4>
          <div class="rec-sub">üí° Tips Praktis:</div>
          ${rec.tips.map(t => `<div class="rec-tip"><span style="color:var(--gold)">‚ñ∏</span> ${esc(t)}</div>`).join("")}
          <div class="rec-sub" style="margin-top:8px">üìö Sumber Belajar:</div>
          ${rec.resources.map(r => `<div class="rec-resource"><span>‚Ä¢</span> ${esc(r)}</div>`).join("")}
        </div>
      `).join("")}
    </div>

    <!-- CP & TP Reference -->
    <div class="card" style="margin-bottom:16px">
      <h3 style="font-size:15px;font-weight:700;margin-bottom:10px">üìã Referensi Pembelajaran</h3>
      <div class="cp-ref">
        <strong>Capaian Pembelajaran (CP):</strong><br>${esc(state.school.cp)}<br><br>
        <strong>Tujuan Pembelajaran (TP):</strong><br>${esc(state.school.tp)}
      </div>
    </div>

    <!-- Actions -->
    <div class="result-actions">
      ${r.student.wa ? `<button class="btn btn-success btn-lg" id="btn-wa-result">üì§ Kirim ke WhatsApp Siswa</button>` : ""}
      <button class="btn btn-ghost btn-lg" id="btn-next-student">‚Üê Nilai Siswa Lain</button>
    </div>
  `;

  // Event listeners
  document.getElementById("btn-back-result").addEventListener("click", () => {
    renderSelectList();
    showScreen("select");
  });

  document.getElementById("btn-next-student").addEventListener("click", () => {
    renderSelectList();
    showScreen("select");
  });

  const waBtn = document.getElementById("btn-wa-result");
  if (waBtn) {
    waBtn.addEventListener("click", () => shareWA(r.student, r));
  }
}

// ============ WHATSAPP SHARE ============
function shareWA(student, r) {
  const msg = [
    `üìù *Hasil Asesmen Writing ‚Äî ${state.school.name}*`,
    ``,
    `üë§ Nama: ${student.name}`,
    `üìö Kelas: ${state.school.kelas}`,
    `üìÖ Tanggal: ${r.timestamp}`,
    ``,
    `üéØ *Capaian Pembelajaran:*`,
    state.school.cp,
    ``,
    `üìå *Tujuan Pembelajaran:*`,
    state.school.tp,
    ``,
    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
    `üìä *SKOR KESELURUHAN: ${r.overall}/100*`,
    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
    ``,
    `üìã *Detail Skor:*`,
    `‚Ä¢ Grammar: ${r.scores.grammar}/100`,
    `‚Ä¢ Vocabulary: ${r.scores.vocabulary}/100`,
    `‚Ä¢ Coherence: ${r.scores.coherence}/100`,
    `‚Ä¢ Task Achievement: ${r.scores.task}/100`,
    `‚Ä¢ Mechanics: ${r.scores.mechanics}/100`,
    ``,
    `‚úÖ *Kekuatan:*`,
    ...r.strengths.map(s => `‚Ä¢ ${s}`),
    ``,
    `üí¨ *Feedback:*`,
    r.feedbackPositive,
    ``,
    `üìñ *Rekomendasi Belajar:*`,
    ...r.recommendations.map(rec =>
      `\n${rec.icon} *${rec.area}:*\n${rec.tips.map(t => `  ‚Ä¢ ${t}`).join("\n")}\nüìö Sumber:\n${rec.resources.map(r => `  ${r}`).join("\n")}`
    ),
    ``,
    `‚úèÔ∏è *Koreksi:*`,
    ...r.corrections.slice(0, 4).map(c => `‚ùå ${c.original}\n‚úÖ ${c.corrected}\nüí° ${c.explanation}`),
    ``,
    `_Dikirim melalui WriteRight Assessment App_`
  ].join("\n");

  let num = student.wa.replace(/\D/g, "");
  if (num.startsWith("0")) num = "62" + num.slice(1);
  window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`, "_blank");
}

// ============ HELPERS ============
function esc(str) {
  if (!str) return "";
  return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}
function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ============ INIT ============
showScreen("setup");
renderStudents();
</script>
</body>
</html>
